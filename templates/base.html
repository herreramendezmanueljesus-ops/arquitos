<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Sistema de Pr√©stamos{% endblock %}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    html, body {
      height: auto !important;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }
    main.container-fluid {
      flex: 1 0 auto;
    }
    footer {
      flex-shrink: 0;
      background-color: #212529;
      color: #ccc;
      padding: 10px 0;
    }
    .resaltado-reactivado {
      background-color: #28a745 !important;
      transition: background-color 1.5s ease-out;
    }
    .resaltado-reactivado.fade-out {
      background-color: transparent !important;
    }
  </style>

  <audio id="audioReactivaCliente">
    <source src="https://cdn.jsdelivr.net/gh/ManzDev/sounds/coin.mp3" type="audio/mpeg">
  </audio>
</head>

<body>

  <!-- üîù Barra de navegaci√≥n -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm mb-4">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="{{ url_for('app_rutas.index') }}">üíº Sistema de Pr√©stamos</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuPrincipal" aria-controls="menuPrincipal" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="menuPrincipal">
        <ul class="navbar-nav mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.index') }}">üè† Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.liquidacion_view') }}">üìä Liquidaci√≥n</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.clientes_cancelados_view') }}">üö´ Cancelados</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.dashboard') }}">üìà Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.ganancias_mes_view') }}">üí∞ Ganancias</a></li>
          <li class="nav-item">
            <button id="btnNuevoCliente" class="btn btn-outline-light btn-sm ms-2">‚ûï Nuevo Cliente</button>
          </li>
        </ul>

        <a href="{{ url_for('app_rutas.logout') }}" class="btn btn-danger btn-sm ms-lg-3 mt-2 mt-lg-0">Salir ‚úñ</a>
      </div>
    </div>
  </nav>

  <!-- üßæ Contenido principal -->
  <main class="container-fluid mb-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <!-- ü¶∂ Pie de p√°gina -->
  <footer class="text-center">
    <small>¬© {{ hoy.year if hoy else '2025' }} Sistema de Pr√©stamos ‚Äî Desarrollado con ‚ù§Ô∏è por Manuel Herrera</small>
  </footer>

  <!-- üîÑ Toast ‚ÄúProcesando...‚Äù -->
  <div id="toastProcesando"
       style="display:none; position:fixed; top:20px; right:20px; z-index:3000;
              background:rgba(0,0,0,0.85); color:white; padding:10px 18px;
              border-radius:10px; font-size:0.9rem; box-shadow:0 2px 10px rgba(0,0,0,0.3);
              opacity:0; transition:opacity 0.3s ease;">
    ‚è≥ Procesando...
  </div>

  <!-- üí¨ Modal de Nuevo Cliente -->
  <div class="modal fade" id="modalNuevoCliente" tabindex="-1" aria-labelledby="nuevoClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title fw-bold">üßæ Nuevo Cliente / Renovaci√≥n</h5>
          <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">Cerrar ‚úñ</button>
        </div>
        <div class="modal-body" id="modalNuevoClienteBody">
          <div class="text-center text-muted py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Cargando formulario...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚öôÔ∏è Scripts -->
  <script>
    function reproducirSonidoReactivado(){
      const a = document.getElementById("audioReactivaCliente");
      if(a) a.play().catch(()=>{});
    }
    function resaltarClienteReactivado(id){
      if(!window.location.pathname.endsWith("/")) return;
      const fila = document.querySelector(`#cliente-row-${id}`);
      if(!fila) return;
      reproducirSonidoReactivado();
      fila.classList.add("resaltado-reactivado");
      setTimeout(()=>{ fila.classList.add("fade-out"); setTimeout(()=>{ fila.classList.remove("resaltado-reactivado","fade-out") },1500); },50);
    }
    function scrollToCliente(id){
      if(!window.location.pathname.endsWith("/")) return;
      const fila = document.querySelector(`#cliente-row-${id}`);
      if(fila) fila.scrollIntoView({ behavior:"smooth", block:"center" });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const toast = document.getElementById("toastProcesando");
      let visible = false;

      function mostrarProcesando() {
        if (visible) return;
        visible = true;
        toast.style.display = "block";
        setTimeout(() => (toast.style.opacity = "1"), 50);
      }
      function ocultarProcesando() {
        visible = false;
        toast.style.opacity = "0";
        setTimeout(() => (toast.style.display = "none"), 300);
      }
      window.mostrarProcesando = mostrarProcesando;
      window.ocultarProcesando = ocultarProcesando;

      document.querySelectorAll("form").forEach(form => {
        form.addEventListener("submit", () => {
          mostrarProcesando();
          setTimeout(ocultarProcesando, 8000);
        });
      });
      document.querySelectorAll("a[href]").forEach(link => {
        const href = link.getAttribute("href");
        if (!href || href.startsWith("#") || href.startsWith("javascript:") || link.target === "_blank") return;
        link.addEventListener("click", () => {
          mostrarProcesando();
          setTimeout(ocultarProcesando, 8000);
        });
      });

      const modalNuevoCliente = new bootstrap.Modal(document.getElementById("modalNuevoCliente"));
      const modalBody = document.getElementById("modalNuevoClienteBody");
      const btnNuevoCliente = document.getElementById("btnNuevoCliente");

      btnNuevoCliente.addEventListener("click", async () => {
        modalBody.innerHTML = `
          <div class="text-center text-muted py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Cargando formulario...</p>
          </div>`;
        modalNuevoCliente.show();

        try {
          mostrarProcesando();
          const resp = await fetch("{{ url_for('app_rutas.nuevo_cliente') }}");
          const html = await resp.text();
          modalBody.innerHTML = html;
        } catch {
          modalBody.innerHTML = `<div class="alert alert-danger text-center mt-3">
            ‚ùå Error al cargar el formulario. Intenta nuevamente.
          </div>`;
        } finally {
          ocultarProcesando();
        }
      });
      window.addEventListener("load", ocultarProcesando);
    });

    function actualizarRelojChile() {
      const opciones = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      const ahoraChile = new Date().toLocaleTimeString('es-CL', opciones);
      const elemento = document.getElementById('horaChile');
      if (elemento) elemento.textContent = ahoraChile;
    }
    setInterval(actualizarRelojChile, 1000);
    actualizarRelojChile();
  </script>

</body>
</html>


