<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Sistema de Pr√©stamos{% endblock %}</title>

  <!-- Optimizaci√≥n para m√≥viles -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    html, body {
      height: auto !important;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }

    main.container-fluid {
      flex: 1 0 auto;
    }

    footer {
      flex-shrink: 0;
      background-color: #212529;
      color: #ccc;
      padding: 10px 0;
    }

    /* Resaltado al reactivar un cliente */
    .resaltado-reactivado {
      background-color: #28a745 !important;
      transition: background-color 1.5s ease-out;
    }
    .resaltado-reactivado.fade-out {
      background-color: transparent !important;
    }

    /* ======================================================
       ‚≠ê BARRA SUPERIOR (LISTADO DE CLIENTES) A TODO EL ANCHO
       ====================================================== */
    .barra-superior-clientes {
      width: 100% !important;
      max-width: none !important;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #212529;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .barra-superior-clientes .barra-superior-titulo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
      font-weight: bold;
    }

    .barra-superior-clientes .reloj-digital {
      display: flex;
      flex-direction: column;
      text-align: right;
      font-size: 0.85rem;
    }

    .barra-superior-clientes .reloj-digital .label {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    .barra-superior-clientes .reloj-digital .hora {
      font-weight: bold;
      font-size: 0.95rem;
    }

    /* Versi√≥n m√≥vil */
    @media (max-width: 768px) {
      .barra-superior-clientes {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        padding: 12px;
      }

      .barra-superior-clientes .reloj-digital {
        text-align: left;
      }
    }

    /* ==========================================
       ‚≠ê MODAL HISTORIAL FULLSCREEN (NUEVO BLOQUE)
       ========================================== */
    @media (max-width: 768px) {
      .modal-historial-cliente {
        margin: 0 !important;
        width: 100vw !important;
        max-width: 100vw !important;
      }

      .modal-historial-cliente .modal-content {
        height: 100vh !important;
        border-radius: 0;
      }

      .modal-historial-cliente .modal-body {
        overflow-y: auto;
      }

      .modal-historial-cliente .tabla-modal-responsive {
        overflow-x: auto;
        width: 100%;
        display: block;
      }

      .modal-historial-cliente table {
        min-width: 900px;
      }
    }

    /* =========================================================
   üì± TABLA DE CLIENTES EN CELULAR
   - No rompe encabezados letra por letra
   - No agranda la p√°gina
   - Mantiene el ‚Äúcab√≠a bien‚Äù como antes
   ========================================================= */
@media (max-width: 768px) {

  /* si no usas este wrapper, no pasa nada */
  .tabla-clientes-wrapper {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
  }

  /* la clave: NO fixed */
  #tabla-clientes {
    width: 100%;
    max-width: 100%;
    table-layout: auto;      /* ‚úÖ antes te funcionaba as√≠ */
    font-size: 0.78rem;
  }

  /* encabezados: NO se rompen por letras */
  #tabla-clientes th {
    white-space: nowrap;     /* ‚úÖ evita ‚ÄúCu / ot / as‚Ä¶‚Äù */
    word-break: keep-all;
    overflow-wrap: normal;
    text-align: center;
    vertical-align: middle;
    padding: 0.25rem 0.35rem;
  }

  /* celdas: igual, sin partir */
  #tabla-clientes td {
    white-space: nowrap;
    padding: 0.25rem 0.35rem;
  }

  /* por si hab√≠a min-width viejo */
  #tabla-clientes {
    min-width: 0 !important;
  }
}

</style>

  <!-- Sonido -->
  <audio id="audioReactivaCliente">
    <source src="https://cdn.jsdelivr.net/gh/ManzDev/sounds/coin.mp3" type="audio/mpeg">
  </audio>
</head>

<body>

  <!-- NAVBAR SUPERIOR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm mb-4">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="{{ url_for('app_rutas.index') }}">üìã Listado de clientes</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuPrincipal">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="menuPrincipal">
        <ul class="navbar-nav mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.index') }}">üè† Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.liquidacion_view') }}">üìä Liquidaci√≥n</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.clientes_cancelados_view') }}">üö´ Cancelados</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.dashboard') }}">üìà Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('app_rutas.ganancias_mes_view') }}">üí∞ Ganancias</a></li>
          <li class="nav-item">
            <button type="button" class="btn btn-outline-light btn-sm ms-2" data-open-nuevo-cliente="1">
              ‚ûï Nuevo Cliente
            </button>
          </li>
        </ul>

        <span class="text-white fw-semibold ms-3" id="horaChile"></span>

        <a href="{{ url_for('app_rutas.logout') }}" class="btn btn-danger btn-sm ms-lg-3 mt-2 mt-lg-0">Salir ‚úñ</a>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="container-fluid mb-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <!-- FOOTER -->
  <footer class="text-center">
    <small>¬© {{ hoy.year if hoy else '2025' }} Sistema de Pr√©stamos</small>
  </footer>

  <!-- TOAST PROCESANDO -->
  <div id="toastProcesando"
       style="display:none; position:fixed; top:20px; right:20px; z-index:3000;
              background:rgba(0,0,0,0.85); color:white; padding:10px 18px;
              border-radius:10px; font-size:0.9rem; box-shadow:0 2px 10px rgba(0,0,0,0.3);
              opacity:0; transition:opacity 0.3s ease;">
    ‚è≥ Procesando...
  </div>

  <!-- MODAL NUEVO CLIENTE -->
  <div class="modal fade" id="modalNuevoCliente" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title fw-bold">üßæ Nuevo Cliente / Renovaci√≥n</h5>
          <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">Cerrar ‚úñ</button>
        </div>
        <div class="modal-body" id="modalNuevoClienteBody">
          <div class="text-center text-muted py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3">Cargando formulario...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS JS (todo lo que ya ten√≠as, tal cual) -->
  <script>
    /* todo tu JS original aqu√≠‚Ä¶ no lo toqu√© */
  </script>

</body>
</html>


  </div>

  <!-- üí¨ Modal de Nuevo Cliente -->
  <div class="modal fade" id="modalNuevoCliente" tabindex="-1" aria-labelledby="nuevoClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title fw-bold">üßæ Nuevo Cliente / Renovaci√≥n</h5>
          <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">Cerrar ‚úñ</button>
        </div>
        <div class="modal-body" id="modalNuevoClienteBody">
          <div class="text-center text-muted py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Cargando formulario...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚öôÔ∏è Scripts -->
  <script>
    // ===================== SONIDO REACTIVAR =====================
    function reproducirSonidoReactivado(){
      const a = document.getElementById("audioReactivaCliente");
      if(a) a.play().catch(()=>{});
    }

    function resaltarClienteReactivado(id){
      if(!window.location.pathname.endsWith("/")) return;
      const fila = document.querySelector("#cliente-row-" + id);
      if(!fila) return;
      reproducirSonidoReactivado();
      fila.classList.add("resaltado-reactivado");
      setTimeout(()=>{
        fila.classList.add("fade-out");
        setTimeout(()=>{
          fila.classList.remove("resaltado-reactivado","fade-out");
        },1500);
      },50);
    }

    function scrollToCliente(id){
      if(!window.location.pathname.endsWith("/")) return;
      const fila = document.querySelector("#cliente-row-" + id);
      if(fila) fila.scrollIntoView({ behavior:"smooth", block:"center" });
    }

    // ===================== RELOJ CHILE (CORREGIDO) =====================
    function actualizarRelojChile() {
      const opciones = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      const ahora = new Date().toLocaleTimeString('es-CL', opciones);
      const lbl = document.getElementById('horaChile');
      if (lbl) lbl.textContent = ahora;
    }
    setInterval(actualizarRelojChile, 1000);
    actualizarRelojChile();

    document.addEventListener("DOMContentLoaded", () => {
      const toast = document.getElementById("toastProcesando");
      let visible = false;

      function mostrarProcesando() {
        if (visible) return;
        visible = true;
        toast.style.display = "block";
        setTimeout(() => (toast.style.opacity = "1"), 50);
      }

      function ocultarProcesando() {
        visible = false;
        toast.style.opacity = "0";
        setTimeout(() => (toast.style.display = "none"), 300);
      }

      window.mostrarProcesando = mostrarProcesando;
      window.ocultarProcesando = ocultarProcesando;

      document.querySelectorAll("form").forEach(form => {
        form.addEventListener("submit", () => {
          mostrarProcesando();
          setTimeout(ocultarProcesando, 8000);
        });
      });

      document.querySelectorAll("a[href]").forEach(link => {
        const href = link.getAttribute("href");
        if (!href || href.startsWith("#") || href.startsWith("javascript:") || link.target === "_blank") return;
        link.addEventListener("click", () => {
          mostrarProcesando();
          setTimeout(ocultarProcesando, 8000);
        });
      });

      const modalEl   = document.getElementById("modalNuevoCliente");
      const modalBody = document.getElementById("modalNuevoClienteBody");
      const modalNuevoCliente = modalEl ? new bootstrap.Modal(modalEl) : null;

      function inicializarFormularioNuevoCliente() {
        if (!modalBody) return;
        const form = modalBody.querySelector("#formCliente");
        if (!form) return;

        const btnGenerarCodigo = modalBody.querySelector("#btnGenerarCodigo");
        const codigo    = modalBody.querySelector("#codigo");
        const monto     = modalBody.querySelector("#monto");
        const interes   = modalBody.querySelector("#interes");
        const plazo     = modalBody.querySelector("#plazo");
        const frecuencia= modalBody.querySelector("#frecuencia");
        const lblTotal  = modalBody.querySelector("#lblTotal");
        const lblCuotas = modalBody.querySelector("#lblCuotas");
        const lblCuota  = modalBody.querySelector("#lblCuota");

        if (btnGenerarCodigo && codigo) {
          btnGenerarCodigo.addEventListener("click", () => {
            let c = "";
            const chars = "0123456789";
            for (let i = 0; i < 6; i++) {
              c += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            codigo.value = c;
          });
        }

        function calcular() {
          const m = parseFloat(monto && monto.value ? monto.value : "0") || 0;
          const i = parseFloat(interes && interes.value ? interes.value : "0") || 0;
          const p = parseInt(plazo && plazo.value ? plazo.value : "0") || 0;
          const f = frecuencia ? frecuencia.value : "diario";

          if (!lblTotal || !lblCuotas || !lblCuota) return;

          if (m <= 0 || p <= 0) {
            lblTotal.textContent = "$0.00";
            lblCuotas.textContent = "0";
            lblCuota.textContent = "$0.00";
            return;
          }

          const total = m + (m * (i / 100));
          let cuotas = 0;

          switch (f) {
            case "diario":   cuotas = p; break;
            case "semanal":  cuotas = Math.ceil(p / 7); break;
            case "quincenal":cuotas = Math.ceil(p / 15); break;
            case "mensual":  cuotas = Math.ceil(p / 30); break;
          }
          if (cuotas <= 0) cuotas = 1;

          const valor = total / cuotas;

          lblTotal.textContent  = "$" + total.toFixed(2);
          lblCuotas.textContent = cuotas.toString();
          lblCuota.textContent  = "$" + valor.toFixed(2);
        }

        [monto, interes, plazo, frecuencia].forEach(e => {
          if (!e) return;
          e.addEventListener("input", calcular);
          e.addEventListener("change", calcular);
        });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const fd = new FormData(form);

          try {
            mostrarProcesando();
            const res = await fetch(form.action, {
              method: "POST",
              body: fd,
              headers: { "X-Requested-With": "fetch" }
            });
            const data = await res.json();

            if (!res.ok || !data.ok) {
              alert(data.error || "No se pudo crear el cliente.");
              return;
            }

            if (data.cliente) {
              try {
                sessionStorage.setItem("nuevo_cliente", JSON.stringify(data.cliente));
              } catch {}
            }

            window.location.href = "{{ url_for('app_rutas.index') }}";

          } catch (err) {
            console.error(err);
            alert("Error al conectar con el servidor.");
          } finally {
            ocultarProcesando();
          }
        });
      }

      async function cargarFormularioNuevoCliente() {
        if (!modalNuevoCliente || !modalBody) return;
        modalBody.innerHTML = `
          <div class="text-center text-muted py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Cargando formulario...</p>
          </div>`;
        modalNuevoCliente.show();

        try {
          mostrarProcesando();
          const resp = await fetch("{{ url_for('app_rutas.nuevo_cliente') }}", {
            headers: { "X-Requested-With": "fetch" }
          });
          const html = await resp.text();
          modalBody.innerHTML = html;

          inicializarFormularioNuevoCliente();

        } catch (err) {
          console.error(err);
          modalBody.innerHTML = `
            <div class="alert alert-danger text-center mt-3">
              ‚ùå Error al cargar el formulario. Intenta nuevamente.
            </div>`;
        } finally {
          ocultarProcesando();
        }
      }

      document.querySelectorAll("[data-open-nuevo-cliente]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          cargarFormularioNuevoCliente();
        });
      });

      window.addEventListener("load", ocultarProcesando);
    });
  </script>

</body>
</html>



