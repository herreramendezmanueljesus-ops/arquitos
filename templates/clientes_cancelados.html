{% extends "base.html" %}
{% block title %}ðŸ“‹ Clientes Cancelados{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-2">ðŸ“‹ Clientes Cancelados</h2>

  {% if total_cancelados is defined %}
  <p class="text-center text-muted mb-4">
    ðŸ§¾ {{ total_cancelados }} clientes cancelados â€” 
    <span class="text-success fw-bold">{{ total_renovados }}</span> renovados
  </p>
  {% endif %}

  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>Orden</th>
          <th>CÃ³digo</th>
          <th>DÃ­as</th>
          <th>Fecha salida</th>
          <th>Nombre</th>
          <th>Salida</th>
          <th>Ãšltimo abono</th>
          <th>Abonar</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody id="tabla-cancelados">
        {% for c in clientes %}
        <tr id="cliente-{{ c.id }}">
          <td>{{ c.orden or loop.index }}</td>
          <td>{{ c.codigo }}</td>
          <td>{{ c.dias }}</td>
          <td>{{ c.fecha_salida }}</td>
          <td class="{% if c.renovado %}text-success fw-bold{% endif %}">
            {{ c.nombre }}
            {% if c.renovado %}
              <i class="bi bi-check-circle-fill ms-1 text-success"></i>
            {% endif %}
          </td>
          <td>${{ "%.2f"|format(c.salida_total) }}</td>
          <td>
            {% if c.ultimo_abono_monto and c.ultimo_abono_monto > 0 %}
              ${{ "%.2f"|format(c.ultimo_abono_monto) }}
            {% else %}
              â€”
            {% endif %}
          </td>
          <td class="abono-td">
            <form class="d-flex justify-content-center form-abono-cancelado" data-id="{{ c.id }}">
              <input type="number"
                     step="0.01"
                     min="0.01"
                     placeholder="0"
                     class="form-control text-end abono-input fw-bold"
                     style="width:120px; height:50px; font-size:1.4rem;"
                     required autocomplete="off">
              <button type="submit"
                      class="btn btn-success ms-2"
                      style="font-size:1.4rem; padding:0 15px;">ðŸ’µ</button>
            </form>
          </td>
          <td>
            <span class="saldo-link text-primary fw-bold"
                  data-id="{{ c.id }}"
                  style="cursor: pointer;">
              ${{ "%.2f"|format(c.saldo or 0.0) }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if not clientes %}
  <div class="alert alert-info text-center mt-4">
    No hay clientes cancelados actualmente.
  </div>
  {% endif %}
</div>

<!-- ðŸ§¾ Modal para mostrar abonos -->
<div class="modal fade" id="modalAbonos" tabindex="-1" aria-labelledby="modalAbonosLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="modalAbonosLabel">Historial de Abonos</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="tablaAbonos"></div>
      </div>
    </div>
  </div>
</div>

<!-- âš™ï¸ Script de eventos -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // ðŸ“˜ Mostrar historial de abonos
  document.querySelectorAll(".saldo-link").forEach((el) => {
    el.addEventListener("click", async () => {
      const id = el.dataset.id;
      const modalBody = document.getElementById("tablaAbonos");
      modalBody.innerHTML = "<p class='text-center'>Cargando abonos...</p>";

      try {
        const resp = await fetch(`/historial_abonos/${id}`);
        const data = await resp.json();

        if (!data.ok) {
          modalBody.innerHTML = `<div class='alert alert-warning text-center'>${data.error || "No se registran abonos para este cliente."}</div>`;
          new bootstrap.Modal(document.getElementById("modalAbonos")).show();
          return;
        }

        const p = data.prestamo;
        let html = `
          <div class="mb-3">
            <h5 class="text-center fw-bold text-primary">${p.nombre}</h5>
            <p class="text-center text-muted mb-1">
              Fecha inicial: <strong>${p.fecha_inicial}</strong> |
              Monto: <strong>$${p.monto.toFixed(2)}</strong> |
              Total: <strong>$${p.total.toFixed(2)}</strong>
            </p>
            <p class="text-center text-muted mb-0">
              Modo: ${p.modo} â€¢ Saldo final: <strong>$${p.saldo.toFixed(2)}</strong>
            </p>
          </div>
        `;

        if (data.abonos.length > 0) {
          html += `
            <table class="table table-bordered table-hover align-middle text-center">
              <thead class="table-dark">
                <tr>
                  <th>CÃ³digo</th><th>Fecha</th><th>Hora</th><th>Monto</th><th>Saldo restante</th>
                </tr>
              </thead>
              <tbody>
                ${data.abonos.map(a => `
                  <tr>
                    <td>${a.codigo}</td>
                    <td>${a.fecha}</td>
                    <td>${a.hora}</td>
                    <td class="text-success fw-bold">$${a.monto.toFixed(2)}</td>
                    <td class="text-primary fw-bold">$${a.saldo.toFixed(2)}</td>
                  </tr>`).join("")}
              </tbody>
              <tfoot class="table-light fw-bold">
                <tr>
                  <td colspan="3" class="text-end">Total abonado:</td>
                  <td colspan="2" class="text-success">$${data.abonos.reduce((s, a) => s + a.monto, 0).toFixed(2)}</td>
                </tr>
              </tfoot>
            </table>`;
        } else {
          html += `<div class="alert alert-info text-center">Este cliente no tiene abonos registrados.</div>`;
        }

        modalBody.innerHTML = html;
        new bootstrap.Modal(document.getElementById("modalAbonos")).show();

      } catch (err) {
        modalBody.innerHTML = "<p class='text-danger text-center'>Error al cargar los abonos.</p>";
        console.error("Error cargando historial:", err);
      }
    });
  });

  // ðŸ’µ Reactivar cliente (sin recargar)
  document.querySelectorAll(".form-abono-cancelado").forEach((form) => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = form.querySelector(".abono-input");
      const id = form.dataset.id;
      const valor = parseFloat(input.value || 0);
      if (valor <= 0) return;

      input.disabled = true;
      form.querySelector("button").disabled = true;
      input.classList.add("bg-warning");

      try {
        const resp = await fetch(`/reactivar_cliente/${id}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "fetch"
          },
          body: new URLSearchParams({ abono: valor }),
        });

        const data = await resp.json();

        if (data.ok) {
          const fila = document.getElementById(`cliente-${id}`);
          fila.classList.add("table-success");
          fila.style.transition = "opacity 0.8s ease";
          fila.style.opacity = "0";
          setTimeout(() => fila.remove(), 800);

          mostrarToast(`âœ… ${data.nombre} reactivado con abono $${valor.toFixed(2)}.`, "success");
        } else {
          mostrarToast(`âš ï¸ ${data.error || "Error al reactivar cliente."}`, "warning");
        }
      } catch (err) {
        mostrarToast("âŒ Error al conectar con el servidor.", "danger");
        console.error("âš ï¸ Error detallado:", err);
      } finally {
        input.disabled = false;
        form.querySelector("button").disabled = false;
        input.classList.remove("bg-warning");
        input.value = "";
      }
    });
  });

  // ðŸ”” FunciÃ³n toast flotante
  function mostrarToast(mensaje, tipo="info") {
    const colores = { success:"alert-success", warning:"alert-warning", danger:"alert-danger", info:"alert-info" };
    const toast = document.createElement("div");
    toast.className = `alert ${colores[tipo]} position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
    toast.style.zIndex = 2000;
    toast.textContent = mensaje;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }
});
</script>

<style>
.abono-td form { align-items: center; justify-content: center; gap: 0.3em; }
.table-success { background-color: #d1e7dd !important; transition: all 0.6s ease; }

/* ðŸŽ¨ Modal de abonos */
#modalAbonos table {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
#modalAbonos th {
  background-color: #0d6efd;
  color: white;
  font-size: 0.85rem;
  letter-spacing: 0.5px;
}
#modalAbonos tr:hover {
  background-color: rgba(13, 110, 253, 0.05);
  transition: 0.3s;
}
</style>
{% endblock %}
