{% extends "base.html" %}
{% block title %}üìã Clientes Cancelados{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-2">üìã Clientes Cancelados</h2>

  {% if total_cancelados is defined %}
  <p class="text-center text-muted mb-4">
    üßæ {{ total_cancelados }} clientes cancelados ‚Äî 
    <span class="text-success fw-bold">{{ total_renovados }}</span> renovados
  </p>
  {% endif %}

  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>Orden</th>
          <th>C√≥digo</th>
          <th>D√≠as</th>
          <th>Fecha salida</th>
          <th>Nombre</th>
          <th>Salida</th>
          <th>√öltimo abono</th>
          <th>Saldo / Historial</th>
        </tr>
      </thead>
      <tbody id="tabla-cancelados">
        {% for c in clientes %}
        <tr id="cliente-{{ c.id }}">
          <td>{{ c.orden or loop.index }}</td>
          <td>{{ c.codigo }}</td>
          <td>{{ c.dias }}</td>
          <td>{{ c.fecha_salida }}</td>
          <td class="{% if c.renovado %}text-success fw-bold{% endif %}">
            {{ c.nombre }}
            {% if c.renovado %}
              <i class="bi bi-check-circle-fill ms-1 text-success"></i>
            {% endif %}
          </td>
          <td>${{ "%.2f"|format(c.salida_total) }}</td>
          <td>
            {% if c.ultimo_abono_monto and c.ultimo_abono_monto > 0 %}
              ${{ "%.2f"|format(c.ultimo_abono_monto) }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td>
            <span class="saldo-link text-primary fw-bold"
                  data-id="{{ c.id }}"
                  data-nombre="{{ c.nombre }}"
                  style="cursor: pointer; text-decoration: underline;">
              ${{ "%.2f"|format(c.saldo or 0.0) }} ‚Äî Ver historial
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if not clientes %}
  <div class="alert alert-info text-center mt-4">
    No hay clientes cancelados actualmente.
  </div>
  {% endif %}
</div>

<!-- üßæ Modal para mostrar/gestionar abonos -->
<div class="modal fade" id="modalAbonos" tabindex="-1" aria-labelledby="modalAbonosLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="modalAbonosLabel">Historial de Abonos</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="tablaAbonos"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // üìò Mostrar historial de abonos (con botones para eliminar)
  document.querySelectorAll(".saldo-link").forEach((el) => {
    el.addEventListener("click", async () => {
      const id = el.dataset.id;
      const nombre = el.dataset.nombre || "";
      const modalBody = document.getElementById("tablaAbonos");
      modalBody.innerHTML = "<p class='text-center'>Cargando abonos...</p>";

      try {
        const resp = await fetch(`/historial_abonos/${id}`);
        const data = await resp.json();

        if (!data.ok) {
          modalBody.innerHTML = `<div class='alert alert-warning text-center'>${data.error || "No se registran abonos para este cliente."}</div>`;
          new bootstrap.Modal(document.getElementById("modalAbonos")).show();
          return;
        }

        const p = data.prestamo;
        let html = `
          <div class="mb-3">
            <h5 class="text-center fw-bold text-primary">${p.nombre}</h5>
            <p class="text-center text-muted mb-1">
              Fecha inicial: <strong>${p.fecha_inicial}</strong> |
              Monto: <strong>$${p.monto.toFixed(2)}</strong> |
              Total: <strong>$${p.total.toFixed(2)}</strong>
            </p>
            <p class="text-center text-muted mb-0">
              Modo: ${p.modo} ‚Ä¢ Saldo final: <strong>$${p.saldo.toFixed(2)}</strong>
            </p>
          </div>
        `;

        if (data.abonos.length > 0) {
          html += `
            <table class="table table-bordered table-hover align-middle text-center">
              <thead class="table-dark">
                <tr>
                  <th>C√≥digo</th><th>Fecha</th><th>Hora</th><th>Monto</th><th>Saldo restante</th><th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody>
                ${data.abonos.map(a => `
                  <tr id="abono-row-${a.id}">
                    <td>${a.codigo}</td>
                    <td>${a.fecha}</td>
                    <td>${a.hora}</td>
                    <td class="text-success fw-bold">$${a.monto.toFixed(2)}</td>
                    <td class="text-primary fw-bold">$${a.saldo.toFixed(2)}</td>
                    <td>
                      ${a.id > 0
                        ? `<button class="btn btn-danger btn-sm eliminar-abono" data-id="${a.id}" data-cliente="${id}">üóëÔ∏è</button>`
                        : "<span>‚Äî</span>"
                      }
                    </td>
                  </tr>`).join("")}
              </tbody>
              <tfoot class="table-light fw-bold">
                <tr>
                  <td colspan="3" class="text-end">Total abonado:</td>
                  <td colspan="3" class="text-success">$${data.abonos.reduce((s, a) => s + a.monto, 0).toFixed(2)}</td>
                </tr>
              </tfoot>
            </table>`;
        } else {
          html += `<div class="alert alert-info text-center">Este cliente no tiene abonos registrados.</div>`;
        }

        modalBody.innerHTML = html;
        new bootstrap.Modal(document.getElementById("modalAbonos")).show();

      } catch (err) {
        modalBody.innerHTML = "<p class='text-danger text-center'>Error al cargar los abonos.</p>";
        console.error("Error cargando historial:", err);
      }
    });
  });

  // üóëÔ∏è Eliminar abono (desde el modal). Si se reactiva, sacar fila de cancelados y llevar al index resaltado.
  document.addEventListener("click", async (e) => {
    if (!e.target.classList.contains("eliminar-abono")) return;

    const abonoId = e.target.dataset.id;
    const clienteId = e.target.dataset.cliente;

    if (!confirm("¬øSeguro que deseas eliminar este abono?")) return;

    try {
      const res = await fetch(`/eliminar_abono/${abonoId}`, {
        method: "POST",
        headers: { "X-Requested-With": "fetch" }
      });
      const data = await res.json();

      if (!res.ok || !data.ok) {
        mostrarToast(`‚ùå ${data.error || "No se pudo eliminar el abono."}`, "danger");
        return;
      }

      // Quitar la fila del abono en el modal
      const filaAbono = document.getElementById(`abono-row-${abonoId}`);
      if (filaAbono) filaAbono.remove();

      // Si el cliente fue reactivado ‚Üí quitarlo de la tabla de cancelados y mandar al √≠ndice con resaltado
      if (data.reactivado) {
        const filaCliente = document.getElementById(`cliente-${clienteId}`);
        if (filaCliente) {
          filaCliente.classList.add("table-success");
          filaCliente.style.transition = "opacity 0.8s ease";
          filaCliente.style.opacity = "0";
          setTimeout(() => filaCliente.remove(), 800);
        }
        mostrarToast("üîÅ Cliente reactivado autom√°ticamente.", "success");
        setTimeout(() => { window.location.href = `/?resaltar=${clienteId}`; }, 900);
      } else {
        // Solo feedback si no cambi√≥ de estado
        mostrarToast("üóëÔ∏è Abono eliminado.", "info");
      }

    } catch (err) {
      mostrarToast("‚ùå Error de conexi√≥n al eliminar abono.", "danger");
      console.error(err);
    }
  });

  // üîî Toast
  function mostrarToast(mensaje, tipo="info") {
    const colores = { success:"alert-success", warning:"alert-warning", danger:"alert-danger", info:"alert-info" };
    const toast = document.createElement("div");
    toast.className = `alert ${colores[tipo]} position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
    toast.style.zIndex = 2000;
    toast.textContent = mensaje;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  }
});
</script>

<style>
.table-success { background-color: #d1e7dd !important; transition: all 0.6s ease; }

/* üé® Modal de abonos */
#modalAbonos table {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
#modalAbonos th {
  background-color: #0d6efd;
  color: white;
  font-size: 0.85rem;
  letter-spacing: 0.5px;
}
#modalAbonos tr:hover {
  background-color: rgba(13, 110, 253, 0.05);
  transition: 0.3s;
}
</style>
{% endblock %}
