{% extends "base.html" %}
{% block title %}üìã Clientes Cancelados{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">üìã Clientes Cancelados</h2>

  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>Orden</th>
          <th>C√≥digo</th>
          <th>D√≠as</th>
          <th>Fecha salida</th>
          <th>Nombre</th>
          <th>Salida</th>
          <th>√öltimo abono</th>
          <th>Abonar</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody id="tabla-cancelados">
        {% for c in clientes %}
        <tr id="cliente-{{ c.id }}">
          <td>{{ c.orden or loop.index }}</td>
          <td>{{ c.codigo }}</td>
          <td>{{ c.dias }}</td>
          <td>{{ c.fecha_salida }}</td>
          <td>{{ c.nombre }}</td>
          <td>${{ "%.2f"|format(c.salida_total) }}</td>
          <td>
            {% if c.ultimo_abono_monto and c.ultimo_abono_monto > 0 %}
              ${{ "%.2f"|format(c.ultimo_abono_monto) }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td class="abono-td">
            <form class="d-flex justify-content-center form-abono-cancelado" data-id="{{ c.id }}">
              <input type="number"
                     step="0.01"
                     min="0.01"
                     placeholder="0"
                     class="form-control text-end abono-input fw-bold"
                     style="width:120px; height:50px; font-size:1.4rem;"
                     required autocomplete="off">
              <button type="submit"
                      class="btn btn-success ms-2"
                      style="font-size:1.4rem; padding:0 15px;">üíµ</button>
            </form>
          </td>
          <td>
            <span class="saldo-link text-primary fw-bold"
                  data-id="{{ c.id }}"
                  style="cursor: pointer;">
              ${{ "%.2f"|format(c.saldo or 0.0) }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if not clientes %}
  <div class="alert alert-info text-center mt-4">
    No hay clientes cancelados actualmente.
  </div>
  {% endif %}
</div>

<!-- üßæ Modal para mostrar abonos -->
<div class="modal fade" id="modalAbonos" tabindex="-1" aria-labelledby="modalAbonosLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="modalAbonosLabel">Historial de Abonos</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="tablaAbonos"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚öôÔ∏è Script de eventos -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // üìò Mostrar historial de abonos
  document.querySelectorAll(".saldo-link").forEach((el) => {
    el.addEventListener("click", async () => {
      const id = el.dataset.id;
      const modalBody = document.getElementById("tablaAbonos");
      modalBody.innerHTML = "<p class='text-center'>Cargando abonos...</p>";

      try {
        const resp = await fetch(`/historial_abonos/${id}`);
        const data = await resp.text();
        modalBody.innerHTML = data;
        new bootstrap.Modal(document.getElementById("modalAbonos")).show();
      } catch {
        modalBody.innerHTML = "<p class='text-danger text-center'>Error al cargar los abonos.</p>";
      }
    });
  });

  // üíµ Reactivar cliente (sin recargar p√°gina)
  document.querySelectorAll(".form-abono-cancelado").forEach((form) => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = form.querySelector(".abono-input");
      const id = form.dataset.id;
      const valor = parseFloat(input.value || 0);
      if (valor <= 0) return;

      input.disabled = true;
      form.querySelector("button").disabled = true;
      input.classList.add("bg-warning");

      try {
        const resp = await fetch(`/reactivar_cliente/${id}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "fetch" // üëà l√≠nea crucial para AJAX
          },
          body: new URLSearchParams({ abono: valor }),
        });

        const data = await resp.json();

        if (data.ok) {
          // üí´ Animar y eliminar fila
          const fila = document.getElementById(`cliente-${id}`);
          fila.classList.add("table-success");
          fila.style.transition = "opacity 0.8s ease";
          fila.style.opacity = "0";
          setTimeout(() => fila.remove(), 800);

          // ‚úÖ Toast visual
          const toast = document.createElement("div");
          toast.className = "alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3 shadow";
          toast.style.zIndex = 2000;
          toast.textContent = `‚úÖ ${data.nombre} reactivado con abono $${valor.toFixed(2)}.`;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 4000);

          // üì° (Opcional) Enviar datos al index si est√° abierto
          if (window.opener) {
            window.opener.postMessage({ tipo: "nuevo_cliente", cliente: data }, "*");
          }
        } else {
          alert("‚ùå " + (data.error || "Error al reactivar cliente."));
        }
      } catch (err) {
        alert("‚ùå Error al conectar con el servidor.");
        console.error("‚ö†Ô∏è Error detallado:", err);
      } finally {
        input.disabled = false;
        form.querySelector("button").disabled = false;
        input.classList.remove("bg-warning");
        input.value = "";
      }
    });
  });
});
</script>

<style>
.abono-td form { align-items: center; justify-content: center; gap: 0.3em; }
.table-success { background-color: #d1e7dd !important; transition: all 0.6s ease; }
</style>
{% endblock %}
