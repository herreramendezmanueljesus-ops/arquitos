{% extends "base.html" %}
{% block title %}ğŸ“œ Historial de Liquidaciones{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">ğŸ“œ Historial de Liquidaciones</h2>
  <p class="text-center text-muted mb-3">
  ğŸ•’ Hora actual en Chile: <span id="horaChile"></span>
</p>

  <!-- ğŸ” FORMULARIO DE BÃšSQUEDA -->
  <form method="get" class="row g-3 mb-4 justify-content-center">
    <div class="col-md-3">
      <label for="desde" class="form-label">Desde</label>
      <input type="date" id="desde" name="desde" value="{{ fecha_desde }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label for="hasta" class="form-label">Hasta</label>
      <input type="date" id="hasta" name="hasta" value="{{ fecha_hasta }}" class="form-control">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">ğŸ” Buscar</button>
    </div>
  </form>

  {% if fecha_desde and fecha_hasta %}
  <p class="text-center text-muted">
    Mostrando desde <strong>{{ fecha_desde }}</strong> hasta <strong>{{ fecha_hasta }}</strong>
  </p>
  {% endif %}

  <!-- ğŸ“‹ TABLA DE LIQUIDACIONES -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>ğŸ“… Fecha</th>
          <th>ğŸ’¼ Caja Anterior</th>
          <th>ğŸ’° Ingresos (Abonos)</th>
          <th>ğŸ’µ Entradas Caja</th>
          <th>ğŸ¦ PrÃ©stamos</th>
          <th>ğŸ’¸ Salidas</th>
          <th>ğŸ§¾ Gastos</th>
          <th>ğŸ’° Caja Final</th>
        </tr>
      </thead>
      <tbody>
        {% if liquidaciones %}
          {% for liq in liquidaciones %}
          <tr>
            <!-- ğŸ“… Fecha -->
            <td>{{ liq.fecha.strftime("%d-%m-%Y") }}</td>

            <!-- ğŸ’¼ Caja anterior -->
            <td>${{ "%.2f"|format(liq.caja_manual or 0) }}</td>

            <!-- ğŸ’° Ingresos (Abonos) -->
            <td>
              <a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='abono', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-success fw-bold hover-underline"
                 title="Ver abonos del dÃ­a">
                ğŸ’° ${{ "%.2f"|format(liq.entradas or 0) }}
              </a>
            </td>

            <!-- ğŸ’µ Entradas manuales -->
            <td>
              <a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='entrada_manual', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-info fw-bold hover-underline"
                 title="Ver entradas manuales">
                ğŸ’µ ${{ "%.2f"|format(liq.entradas_caja or 0) }}
              </a>
            </td>

            <!-- ğŸ¦ PrÃ©stamos -->
            <td>
              <a href="{{ url_for('app_rutas.prestamos_por_dia', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-primary fw-bold hover-underline"
                 title="Ver prÃ©stamos otorgados">
                ğŸ¦ ${{ "%.2f"|format(liq.prestamos_hoy or 0) }}
              </a>
            </td>

            <!-- ğŸ’¸ Salidas -->
            <td>
              <a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='salida', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-warning fw-bold hover-underline"
                 title="Ver salidas de efectivo">
                ğŸ’¸ ${{ "%.2f"|format(liq.salidas or 0) }}
              </a>
            </td>

            <!-- ğŸ§¾ Gastos -->
            <td>
              <a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='gasto', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-danger fw-bold hover-underline"
                 title="Ver gastos del dÃ­a">
                ğŸ§¾ ${{ "%.2f"|format(liq.gastos or 0) }}
              </a>
            </td>

            <!-- ğŸ’° Caja final -->
            {% if (liq.caja or 0) >= 0 %}
              <td class="text-success"><strong>${{ "%.2f"|format(liq.caja or 0) }}</strong></td>
            {% else %}
              <td class="text-danger"><strong>${{ "%.2f"|format(liq.caja or 0) }}</strong></td>
            {% endif %}
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="8" class="text-muted">No hay liquidaciones en el rango seleccionado.</td></tr>
        {% endif %}
      </tbody>

      {% if liquidaciones %}
      <tfoot class="table-light">
        <tr>
          <th>Total</th>
          <th>-</th>
          <th class="text-success fw-bold">${{ "%.2f"|format(total_entradas) }}</th>
          <th class="text-info fw-bold">${{ "%.2f"|format(total_entradas_caja) }}</th>
          <th class="text-primary fw-bold">${{ "%.2f"|format(total_prestamos) }}</th>
          <th class="text-warning fw-bold">${{ "%.2f"|format(total_salidas) }}</th>
          <th class="text-danger fw-bold">${{ "%.2f"|format(total_gastos) }}</th>
          <th class="text-success fw-bold">${{ "%.2f"|format(total_caja) }}</th>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>

  <!-- ğŸ”™ Volver -->
  <div class="mt-3 text-center">
    <a href="{{ url_for('app_rutas.liquidacion_view') }}" class="btn btn-secondary">
      â¬…ï¸ Volver a LiquidaciÃ³n del DÃ­a
    </a>
  </div>
</div>

<!-- ğŸ¨ Estilos adicionales -->
<style>
  .table td, .table th {
    vertical-align: middle;
  }

  .text-success strong { color: #198754; }
  .text-danger strong { color: #dc3545; }
  .text-warning strong { color: #ffc107; }
  .text-primary strong { color: #0d6efd; }

  .hover-underline:hover {
    text-decoration: underline;
    opacity: 0.9;
    cursor: pointer;
  }

  .btn-secondary {
    border-radius: 10px;
    padding: 8px 18px;
  }
</style>
{% endblock %}
