{% extends "base.html" %}
{% block title %}üßæ Nuevo Cliente{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
  <!-- üîπ Marco azul exterior -->
  <div class="card shadow-lg border border-primary border-3 rounded-4">
    <div class="card-body p-4 position-relative">

      <!-- üî¥ Bot√≥n cerrar (redirige al index) -->
      <a href="{{ url_for('app_rutas.index') }}" 
         class="btn btn-danger btn-sm fw-bold position-absolute top-0 end-0 m-3">
        ‚úñ Cerrar
      </a>

      <!-- üßæ T√≠tulo -->
      <h3 class="text-center fw-bold text-primary mb-1">üßæ Nuevo Cliente / Renovaci√≥n</h3>
      <p class="text-center text-muted mb-4">üïí Hora actual: {{ hora_actual() }}</p>

      <form action="{{ url_for('app_rutas.nuevo_cliente') }}" method="POST" autocomplete="off" id="formCliente">

        <!-- 1Ô∏è‚É£ PRIMER PASO -->
        <div class="p-4 mb-4 rounded-3 border border-primary bg-light">
          <h5 class="text-center fw-bold text-secondary mb-3">1Ô∏è‚É£ Primer Paso: Datos del Cliente</h5>

          <div class="row justify-content-center mb-3">
            <div class="col-md-5 mb-3">
              <label class="form-label fw-semibold">Nombre</label>
              <input type="text" name="nombre" id="nombre" class="form-control text-center" placeholder="Ej: Juan P√©rez">
            </div>

            <div class="col-md-5 mb-3">
              <label class="form-label fw-semibold">Direcci√≥n</label>
              <input type="text" name="direccion" id="direccion" class="form-control text-center" placeholder="Ej: Calle 123, Santiago">
            </div>
          </div>

          <div class="text-center">
            <button type="button" id="btnGenerarCodigo" class="btn btn-primary px-4 py-2 fw-bold">
              ‚öôÔ∏è Generar C√≥digo
            </button>
          </div>
        </div>

        <!-- 2Ô∏è‚É£ SEGUNDO PASO -->
<div class="p-4 mb-4 rounded-3 border border-primary bg-light">
  <h5 class="text-center fw-bold text-secondary mb-3">2Ô∏è‚É£ Segundo Paso: Datos del Pr√©stamo</h5>

  <div class="row justify-content-center g-3 mb-4">
    <div class="col-12 col-md-3">
      <label class="form-label fw-semibold">C√≥digo Cliente</label>
      <input
        type="text"
        name="codigo"
        id="codigo"
        class="form-control text-center"
        placeholder="C√≥digo generado o existente"
        required
        pattern="[0-9]{6}(_R[0-9]+)?"
        title="Debe tener 6 d√≠gitos o un c√≥digo de renovaci√≥n (ej: 101633 o 101633_R1761430834)">
      <small class="text-muted">Puedes usar un c√≥digo existente o uno generado arriba</small>
    </div>

    <div class="col-12 col-md-2">
      <label class="form-label fw-semibold">Orden</label>
      <input type="number" name="orden" id="orden" class="form-control text-center" min="1" placeholder="1" required>
    </div>

    <div class="col-12 col-md-2">
      <label class="form-label fw-semibold">Monto</label>
      <input type="number" step="0.01" min="0.01" id="monto" name="monto" class="form-control text-center" required>
    </div>

    <div class="col-12 col-md-2">
      <label class="form-label fw-semibold">Inter√©s (%)</label>
      <input type="number" step="0.01" min="0" id="interes" name="interes" class="form-control text-center" required>
    </div>

    <div class="col-12 col-md-2">
      <label class="form-label fw-semibold">Plazo (d√≠as)</label>
      <input type="number" id="plazo" name="plazo" class="form-control text-center" min="1" required>
    </div>
  </div>

  <div class="row justify-content-center g-3">
    <div class="col-12 col-md-3">
      <label class="form-label fw-semibold">Frecuencia</label>
      <select name="frecuencia" id="frecuencia" class="form-select text-center">
        <option value="diario" selected>Diario</option>
        <option value="semanal">Semanal</option>
        <option value="quincenal">Quincenal</option>
        <option value="mensual">Mensual</option>
      </select>
    </div>
  </div>
</div>
        <!-- üìä C√ÅLCULO AUTOM√ÅTICO -->
        <div class="p-4 mb-4 rounded-3 border border-primary bg-light text-center">
          <h6 class="fw-bold mb-3 text-muted">üìà C√°lculo Autom√°tico del Pr√©stamo</h6>

          <div class="row justify-content-center">
            <div class="col-md-3">
              <p class="text-muted mb-0">üíµ Total con Inter√©s</p>
              <h5 id="lblTotal" class="fw-bold text-primary">$0.00</h5>
            </div>

            <div class="col-md-3">
              <p class="text-muted mb-0">üìÜ N√∫mero de Cuotas</p>
              <h5 id="lblCuotas" class="fw-bold text-dark">0</h5>
            </div>

            <div class="col-md-3">
              <p class="text-muted mb-0">üí∏ Cuota Estimada</p>
              <h5 id="lblCuota" class="fw-bold text-success">$0.00</h5>
            </div>
          </div>
        </div>

        <!-- ‚úÖ BOT√ìN GUARDAR -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-success px-4 py-2">üíæ Guardar Cliente</button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- ‚öôÔ∏è Script -->
<script>
(function(){
  const btnGenerarCodigo = document.getElementById("btnGenerarCodigo");
  const codigo = document.getElementById("codigo");
  const monto = document.getElementById("monto");
  const interes = document.getElementById("interes");
  const plazo = document.getElementById("plazo");
  const frecuencia = document.getElementById("frecuencia");
  const lblTotal = document.getElementById("lblTotal");
  const lblCuotas = document.getElementById("lblCuotas");
  const lblCuota = document.getElementById("lblCuota");

  btnGenerarCodigo.addEventListener("click", () => {
    let c = "";
    const chars = "0123456789";
    for (let i = 0; i < 6; i++) c += chars.charAt(Math.floor(Math.random() * chars.length));
    codigo.value = c;
  });

  function calcular() {
    const m = parseFloat(monto.value) || 0;
    const i = parseFloat(interes.value) || 0;
    const p = parseInt(plazo.value) || 0;
    const f = frecuencia.value;

    if (m <= 0 || p <= 0) {
      lblTotal.textContent = "$0.00";
      lblCuotas.textContent = "0";
      lblCuota.textContent = "$0.00";
      return;
    }

    const total = m + (m * (i / 100));
    let cuotas = 0;

    switch (f) {
      case "diario": cuotas = p; break;
      case "semanal": cuotas = Math.ceil(p / 7); break;
      case "quincenal": cuotas = Math.ceil(p / 15); break;
      case "mensual": cuotas = Math.ceil(p / 30); break;
    }

    const valor = total / cuotas;

    lblTotal.textContent = "$" + total.toFixed(2);
    lblCuotas.textContent = cuotas.toString();
    lblCuota.textContent = "$" + valor.toFixed(2);
  }

  [monto, interes, plazo, frecuencia].forEach(e => {
    e.addEventListener("input", calcular);
    e.addEventListener("change", calcular);
  });
})();
</script>

<!-- ‚ö° AJAX para crear cliente en vivo -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("formCliente");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fd = new FormData(form);

        try {
            const res = await fetch(form.action, {
                method: "POST",
                body: fd,
                headers: { "X-Requested-With": "fetch" }
            });

            const data = await res.json();

            if (!res.ok || !data.ok) {
                alert(data.error || "No se pudo crear el cliente.");
                return;
            }

            // info del nuevo cliente
            const c = data.cliente;
            sessionStorage.setItem("nuevo_cliente", JSON.stringify(c));

            // volver al index
            window.location.href = "{{ url_for('app_rutas.index') }}";

        } catch (err) {
            console.error(err);
            alert("Error al conectar con el servidor.");
        }
    });
});
</script>

<style>
h3, h5 { letter-spacing: 0.5px; }
.card { background: #fefefe; }
.form-label { font-weight: 600; color: #444; }
input.form-control, select.form-select {
  border-radius: 0.5rem;
  text-align: center;
}
input:focus, select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.15rem rgba(13,110,253,0.15);
}
#btnGenerarCodigo {
  font-weight: 600;
  letter-spacing: 0.5px;
}
#lblTotal, #lblCuota, #lblCuotas {
  font-size: 1.2rem;
}
</style>
{% endblock %}
