{% extends "base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}

<!-- =================== BARRA SUPERIOR: LISTADO + RELOJ =================== -->
<div class="barra-superior-clientes">
  <div class="barra-superior-titulo">
    <span class="emoji">üìã</span>
    <span>Listado de clientes</span>
  </div>

  <div class="reloj-digital">
    <span class="label">Hora Chile</span>
    <!-- usamos el mismo span que ya actualizas con JS -->
    <span class="hora" id="horaChile"></span>
  </div>
</div>

<!-- =================== BUSCADOR DE CLIENTES =================== -->
<div class="mb-3">
  <input type="text" id="buscarCliente" class="form-control"
         placeholder="üîç Buscar cliente por nombre...">
</div>

{# aqu√≠ ya seguir√≠a tu tabla de clientes como la tienes ahora #}
<!-- =================== TABLA DE CLIENTES =================== -->
{% if clientes %}
<table id="tabla-clientes" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>C√≥digo</th>
      <th>Fecha</th>
      <th>Nombre</th>
      <th>Venta</th>
      <th>Cuota</th>
      <th>Cuotas Atrasadas</th>
      <th>√öltimo Abono</th>
      <th>Abonar</th>
      <th>Saldo</th>
      <th>Eliminar</th>
    </tr>
  </thead>

  <tbody>
  {% for c in clientes %}
    {# üßÆ √öltimo pr√©stamo del cliente (si tiene) #}
    {% set u = (c.prestamos|sort(attribute='fecha'))|last if c.prestamos else None %}

    <tr id="cliente-row-{{ c.id }}"
    class="fila-cliente
      {% if c.cancelado %}
        cancelado
      {% elif c.estado_plazo and c.estado_plazo|lower == 'vencido' %}
        plazo-vencido
      {% elif c.estado_plazo and c.estado_plazo|lower == 'moroso' %}
        plazo-moroso
      {% endif %}
    ">

      <!-- ORDEN -->
      <td style="width:100px;">
        <input type="number"
               class="form-control text-center orden-input"
               value="{{ c.orden }}"
               data-id="{{ c.id }}"
               style="width:70px;"
               {% if c.cancelado %}disabled{% endif %}>
      </td>

      <!-- DATOS PRINCIPALES -->
      <td>{{ c.codigo }}</td>
      <td>{{ c.fecha_creacion.strftime("%d/%m/%Y") }}</td>
      <td class="nombre-cliente">{{ c.nombre }}</td>

      <!-- MONTO PRESTADO (sin inter√©s) -->
      <td>{{ "%.2f"|format(c.capital_total_sin_interes()) }}</td>

      <!-- CUOTA -->
      <td>
        {{ "%.2f"|format(c.valor_cuota()) }}
        {% if c.prestamos %}
          {% set u = (c.prestamos|sort(attribute='fecha'))|last %}
          {% if u.frecuencia %}
            <small class="text-muted">({{ u.frecuencia }})</small>
          {% endif %}
        {% endif %}
      </td>

      <!-- CUOTAS ATRASADAS -->
      <td>{{ c.cuotas_atrasadas() }}</td>

      <!-- √öLTIMO ABONO -->
      <td id="ultimo-abono-{{ c.id }}">
        {{ "%.2f"|format(c.ultimo_abono_monto()) }}
      </td>

      <!-- ABONAR -->
      <td class="abono-td">
        <form action="{{ url_for('app_rutas.registrar_abono_por_codigo') }}"
              method="post"
              class="d-flex justify-content-center form-abono"
              data-orden="{{ c.orden }}">
          <input type="hidden" name="codigo" value="{{ c.codigo }}">
          <input type="number" step="0.01" min="0.01" name="monto" placeholder="0"
                 class="form-control text-end abono-input fw-bold {% if c.ultimo_abono_fecha == hoy %}bg-success text-white{% endif %}"
                 style="width:120px; height:50px; font-size:1.4rem;"
                 required autocomplete="off">
          <button type="submit" class="btn btn-success ms-2" style="font-size:1.4rem; padding:0 15px;">üíµ</button>
        </form>

        {% if c.cancelado %}
          <small class="text-danger fw-bold d-block mt-1">Cancelado</small>
        {% endif %}
      </td>

      <!-- SALDO -->
      <td>
        {% if c.cancelado %}
          <span class="text-muted saldo-texto" data-cliente-id="{{ c.id }}">0.00</span>
        {% else %}
          <button class="btn btn-link p-0 saldo-clickable saldo-texto" data-cliente-id="{{ c.id }}">
            {{ "%.2f"|format(c.saldo_total()) }}
          </button>
        {% endif %}
      </td>

      <!-- üóëÔ∏è ELIMINAR CLIENTE -->
      <td>
        <button class="btn btn-danger btn-sm eliminar-cliente-btn"
                data-id="{{ c.id }}"
                data-nombre="{{ c.nombre }}">
          üóëÔ∏è Eliminar
        </button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
  <div class="alert alert-info text-center mt-4">
    No hay clientes registrados a√∫n.
  </div>
{% endif %}

<!-- =================== MODAL EDITAR PR√âSTAMO =================== -->
<div class="modal fade" id="modalEditarPrestamo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditarPrestamo" method="POST">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Editar Pr√©stamo de <span id="clienteNombre"></span></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Plazo (d√≠as)</label>
            <input type="number" name="plazo" id="editarPlazo" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Inter√©s (%)</label>
            <input type="number" step="0.01" name="interes" id="editarInteres" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Frecuencia</label>
            <select name="frecuencia" id="editarFrecuencia" class="form-select">
              <option value="diario">Diario</option>
              <option value="semanal">Semanal</option>
              <option value="quincenal">Quincenal</option>
              <option value="mensual">Mensual</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- =================== MODAL HISTORIAL (SALDO CLICK) =================== -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      
      <!-- HEADER -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalHistorialLabel">üìò Detalles del Cliente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body">

        <!-- DATOS DEL PR√âSTAMO -->
        <h6 class="fw-bold mb-3">Datos del Pr√©stamo</h6>
        <table class="table table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>Fecha inicial</th>
              <th>Monto</th>
              <th>Total</th>
              <th>Cuota</th>
              <th>Modo</th>
              <th>Datos</th>
              <th>Saldo</th>
            </tr>
          </thead>
          <tbody id="tablaDatosPrestamo">
            <tr><td colspan="8"><em>Cargando...</em></td></tr>
          </tbody>
        </table>

        <!-- HISTORIAL DE ABONOS -->
        <h6 class="fw-bold mt-4 mb-3">Historial de Abonos</h6>
        <table class="table table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>C√≥digo</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Abono</th>
              <th>Saldo</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="tablaHistorialBody">
            <tr><td colspan="6"><em>Cargando...</em></td></tr>
          </tbody>
        </table>

      </div>
    </div>
  </div>
</div>
<!-- =================== SCRIPTS PRINCIPALES =================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // ==================================================
  //  üîä Soniditos
  // ==================================================
  function playSound(success = true) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = success ? "triangle" : "sawtooth";
      osc.frequency.setValueAtTime(success ? 880 : 220, ctx.currentTime);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.15);
    } catch {}
  }

  // ==================================================
  //  ‚úèÔ∏è EDITAR PR√âSTAMO (protegido)
  // ==================================================
  const modalEditarEl = document.getElementById("modalEditarPrestamo");
  const formEditar = document.getElementById("formEditarPrestamo");
  let modalEditar = null;

  if (modalEditarEl && formEditar && window.bootstrap) {
    modalEditar = new bootstrap.Modal(modalEditarEl);

    document.querySelectorAll(".editar-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        document.getElementById("clienteNombre").textContent = btn.dataset.nombre;
        try {
          const res = await fetch(`/editar_prestamo/${id}`);
          const data = await res.json();
          if (!data.ok) return alert(data.error || "Error al cargar datos.");
          document.getElementById("editarPlazo").value = data.data.plazo;
          document.getElementById("editarInteres").value = data.data.interes;
          document.getElementById("editarFrecuencia").value = data.data.frecuencia || "diario";
          formEditar.dataset.id = id;
          modalEditar.show();
        } catch {
          alert("Error de conexi√≥n.");
        }
      });
    });

    formEditar.addEventListener("submit", async e => {
      e.preventDefault();
      const id = formEditar.dataset.id;
      const fd = new FormData(formEditar);
      const res = await fetch(`/editar_prestamo/${id}`, { method: "POST", body: fd });
      const data = await res.json();
      if (data.ok) {
        alert("‚úÖ Cambios guardados.");
        location.reload();
      } else {
        alert("‚ùå " + (data.error || "Error al guardar."));
      }
    });
  }

  // ==================================================
  //  üí∞ REGISTRAR ABONOS EN VIVO
  // ==================================================
  const forms = document.querySelectorAll(".form-abono");
  forms.forEach(form => {
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const input = form.querySelector("input[name='monto']");
      const formData = new FormData(form);

      try {
        const res = await fetch(form.action, {
          method: "POST",
          body: formData,
          headers: { "X-Requested-With": "fetch" }
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          playSound(false);
          alert(data.error || "‚ùå Error al registrar abono.");
          return;
        }

        console.log("üì• Respuesta de abono:", data);

        // üí° Inter√©s mensual aplicado
        if (data.interes_aplicado) {
          const fila = document.getElementById(`cliente-row-${data.cliente_id}`);
          if (fila) {
            fila.classList.remove("interes-vencido");

            const alerta = document.createElement("div");
            alerta.textContent = "üí° Inter√©s aplicado";
            alerta.style.position = "absolute";
            alerta.style.backgroundColor = "#d1e7dd";
            alerta.style.color = "#0f5132";
            alerta.style.padding = "4px 8px";
            alerta.style.borderRadius = "6px";
            alerta.style.fontSize = "0.9em";
            alerta.style.fontWeight = "bold";
            alerta.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
            alerta.style.zIndex = "9999";

            const rect = fila.getBoundingClientRect();
            alerta.style.left = `${rect.left + 100}px`;
            alerta.style.top = `${rect.top + window.scrollY - 10}px`;

            document.body.appendChild(alerta);
            setTimeout(() => alerta.remove(), 2000);
          }
        }

        playSound(true);

        // üßÆ Actualizar saldo
        const saldoElem = document.querySelector(`.saldo-texto[data-cliente-id="${data.cliente_id}"]`);
        if (saldoElem && typeof data.saldo !== "undefined") {
          saldoElem.textContent = Number(data.saldo).toFixed(2);
          saldoElem.style.transition = "background-color 0.6s";
          saldoElem.style.backgroundColor = "rgba(0,255,0,0.2)";
          setTimeout(() => saldoElem.style.backgroundColor = "", 800);
        }

        // üü° ACTUALIZAR "√öLTIMO ABONO" MOSTRANDO EL MONTO
        const celdaUltimo = document.getElementById(`ultimo-abono-${data.cliente_id}`);
        if (celdaUltimo && typeof data.monto !== "undefined") {
          celdaUltimo.textContent = Number(data.monto).toFixed(2);
        }

        // üö© Cancelado ‚áí animar y eliminar fila
        const fila = document.getElementById(`cliente-row-${data.cliente_id}`);
        if (data.cancelado) {
          if (fila) {
            fila.classList.add("table-danger");
            fila.style.transition = "opacity 0.8s ease";
            fila.style.opacity = "0";
            setTimeout(() => fila.remove(), 800);
          }

          const toast = document.createElement("div");
          toast.className = "alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3 shadow";
          toast.style.zIndex = 2000;
          toast.textContent = `‚úÖ ${data.cliente_nombre || "Cliente"} qued√≥ en saldo 0 y fue movido a cancelados.`;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 4000);
        }

        // ‚ú® limpiar input y dejarlo verde un rato
        if (input) {
          input.value = "";
          input.classList.add("bg-success", "text-white");
          setTimeout(() => {
            input.classList.remove("bg-success", "text-white");
          }, 5000);
        }

      } catch (err) {
        playSound(false);
        alert("‚ùå Error al conectar con el servidor.");
        console.error(err);
      }
    });
  });

  // ==================================================
  //  üìò HISTORIAL DE ABONOS (click en saldo)
  // ==================================================
  const modalHistorialEl = document.getElementById("modalHistorial");
  let modalHistorial = null;
  if (modalHistorialEl && window.bootstrap) {
    modalHistorial = new bootstrap.Modal(modalHistorialEl);
  }

  document.querySelectorAll(".saldo-clickable").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-cliente-id");

      if (!id) {
        alert("No se pudo obtener el ID del cliente.");
        return;
      }

      const datos = document.getElementById("tablaDatosPrestamo");
      const tbody = document.getElementById("tablaHistorialBody");

      datos.innerHTML = `<tr><td colspan="8"><em>Cargando...</em></td></tr>`;
      tbody.innerHTML = `<tr><td colspan="6"><em>Cargando...</em></td></tr>`;

      try {
        const res = await fetch(`/historial_abonos/${id}`);
        const data = await res.json();

        if (!data.ok) {
          const msg = data.error || "Este cliente no tiene pr√©stamo registrado.";
          datos.innerHTML = `<tr><td colspan="8"><em>${msg}</em></td></tr>`;
          tbody.innerHTML = `<tr><td colspan="6"><em>${msg}</em></td></tr>`;
          if (modalHistorial) modalHistorial.show();
          return;
        }

        const p = data.prestamo;

        datos.innerHTML = `
          <tr>
            <td>${p.nombre}</td>
            <td>${p.fecha_inicial}</td>
            <td>$${p.monto.toFixed(2)}</td>
            <td>$${p.total.toFixed(2)}</td>
            <td>$${p.cuota.toFixed(2)}</td>
            <td>${p.modo}</td>
            <td>${p.datos}</td>
            <td>$${p.saldo.toFixed(2)}</td>
          </tr>`;

        tbody.innerHTML = data.abonos.length
          ? data.abonos.map(a => {
              const btnEliminar = a.id > 0
                ? '<button class="btn btn-danger btn-sm eliminar-abono" data-id="' + a.id + '" data-cliente="' + id + '">üóëÔ∏è</button>'
                : '<span>‚Äî</span>';

              return `
                <tr>
                  <td>${a.codigo}</td>
                  <td>${a.fecha}</td>
                  <td>${a.hora}</td>
                  <td>$${a.monto.toFixed(2)}</td>
                  <td>$${a.saldo.toFixed(2)}</td>
                  <td>${btnEliminar}</td>
                </tr>`;
            }).join("")
          : `<tr><td colspan="6"><em>Este cliente no tiene abonos registrados.</em></td></tr>`;

        if (modalHistorial) modalHistorial.show();

      } catch (err) {
        datos.innerHTML = `<tr><td colspan="8"><em>Error al conectar.</em></td></tr>`;
        tbody.innerHTML = `<tr><td colspan="6"><em>No se pudo cargar el historial.</em></td></tr>`;
        if (modalHistorial) modalHistorial.show();
      }
    });
  });

  // ==================================================
  //  üóëÔ∏è ELIMINAR ABONO (desde el modal)
  // ==================================================
  document.addEventListener("click", async (e) => {
    if (!e.target.classList.contains("eliminar-abono")) return;

    const id = e.target.dataset.id;
    const clienteId = e.target.dataset.cliente;
    if (!confirm("¬øSeguro que deseas eliminar este abono?")) return;

    try {
      const res = await fetch(`/eliminar_abono/${id}`, {
        method: "POST",
        headers: { "X-Requested-With": "fetch" }
      });
      const data = await res.json();

      if (!data.ok) {
        alert("‚ùå " + (data.error || "No se pudo eliminar."));
        return;
      }

      const fila = e.target.closest("tr");
      if (fila) fila.remove();

      const saldoElem = document.querySelector(`.saldo-texto[data-cliente-id="${clienteId}"]`);
      if (saldoElem && typeof data.saldo !== "undefined") {
        saldoElem.textContent = Number(data.saldo).toFixed(2);
        saldoElem.style.transition = "background-color 0.6s";
        saldoElem.style.backgroundColor = "rgba(255, 0, 0, 0.15)";
        setTimeout(() => saldoElem.style.backgroundColor = "", 800);
      }

      playSound(true);
      alert("üóëÔ∏è Abono eliminado correctamente.");
    } catch (err) {
      playSound(false);
      alert("Error de conexi√≥n al eliminar abono.");
    }
  });

});
</script>

<!-- =================== BUSCADOR EN TIEMPO REAL =================== -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("buscarCliente");
  const filas = document.querySelectorAll(".fila-cliente");

  input.addEventListener("keyup", function() {
    const texto = this.value.toLowerCase().trim();
    filas.forEach(fila => {
      const nombre = fila.querySelector(".nombre-cliente").textContent.toLowerCase();
      fila.style.display = nombre.includes(texto) ? "" : "none";
    });
  });
});
</script>

{% if request.args.get("resaltar") %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const id = "{{ request.args.get('resaltar') }}";
    resaltarClienteReactivado(id);
});
</script>
{% endif %}

<!-- =================== ESTILOS =================== -->
<style>
/* üö´ Cliente cancelado */
.cancelado > td,
.cancelado > th {
  background-color: #f8d7da !important;
  color: #721c24 !important;
}

/* üü† Cliente vencido */
.plazo-vencido > td,
.plazo-vencido > th {
  background-color: rgba(255, 193, 7, 0.22) !important;
}

/* üî¥ Cliente moroso */
.plazo-moroso > td,
.plazo-moroso > th {
  background-color: rgba(220, 53, 69, 0.22) !important;
}

/* ‚ù§Ô∏è Inter√©s mensual vencido */
.interes-vencido > td,
.interes-vencido > th {
  background-color: rgba(220, 53, 69, 0.28) !important;
}

/* üí∞ Celda de abono (input) */
.abono-td form {
  align-items: center;
  justify-content: center;
  gap: 0.3em;
}

/* üíµ Saldo clickeable */
.saldo-clickable {
  font-size: 1em;
  font-weight: bold;
  color: #0d6efd;
  text-decoration: underline;
  cursor: pointer;
}

/* üîî Animaci√≥n ligera (cuando reactivas cliente) */
.resaltado-reactivado {
  background-color: rgba(40, 167, 69, 0.4) !important;
  transition: background-color 1.5s ease-out;
}
.resaltado-reactivado.fade-out {
  background-color: transparent !important;
}

/* ‚≠ê‚≠ê‚≠ê BARRA SUPERIOR + RELOJ DIGITAL ‚≠ê‚≠ê‚≠ê */

.barra-superior-clientes {
  width: 100%;
  background-color: #000;
  color: #fff;
  padding: 0.6rem 0.9rem;
  border-radius: 0.55rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.barra-superior-titulo {
  font-weight: 600;
  font-size: 1.05rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.barra-superior-titulo span.emoji {
  font-size: 1.2rem;
}

.reloj-digital {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  font-family: "Courier New", monospace;
}

.reloj-digital .label {
  font-size: 0.78rem;
  text-transform: uppercase;
  opacity: 0.8;
}

.reloj-digital .hora {
  padding: 0.18rem 0.7rem;
  border-radius: 0.35rem;
  background: #111;
  border: 1px solid #444;
  box-shadow: 0 0 8px rgba(0, 255, 149, 0.45);
  color: #00ff95;
  letter-spacing: 0.09em;
  font-weight: 600;
  font-size: 0.9rem;
}
</style>
{% endblock %}
