
{% extends "base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<h2 class="mb-4">üìã Listado de Clientes</h2>

<!-- =================== BOTONES PRINCIPALES =================== -->
<div class="mb-3 d-flex flex-wrap gap-2">
  <a class="btn btn-primary" href="{{ url_for('rutas.nuevo_cliente') }}">‚ûï Nuevo Cliente</a>
  <a class="btn btn-secondary" href="{{ url_for('rutas.liquidacion_view') }}">üìä Ver Liquidaci√≥n</a>
  <a class="btn btn-outline-dark" href="{{ url_for('rutas.clientes_cancelados_view') }}">üö´ Cancelados</a>
</div>

<!-- =================== FECHA Y TOTALES =================== -->
<p><strong>Fecha:</strong> {{ hoy.strftime("%d/%m/%Y") }}</p>
<div class="mb-3">
  <strong>Caja total:</strong> ${{ "%.2f"|format(resumen.caja_total) }} |
  <strong>Cartera total:</strong> ${{ "%.2f"|format(resumen.cartera_total) }}
</div>

<!-- =================== TABLA DE CLIENTES =================== -->
{% if clientes %}
<table id="tabla-clientes" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>C√≥digo</th>
      <th>Fecha</th>
      <th>Nombre</th>
      <th>Venta</th>
      <th>Cuota</th>
      <th>Cuotas Atrasadas</th>
      <th>√öltimo Abono</th>
      <th>Abonar</th>
      <th>Saldo</th>
      <th>Editar</th>
      <th>Eliminar</th>
    </tr>
  </thead>
  <tbody>
    {% for c in clientes %}
    <tr id="cliente-{{ c.id }}"
        class="{% if c.cancelado %}cancelado{% elif c.estado_plazo == 'vencido' %}plazo-vencido{% elif c.estado_plazo == 'moroso' %}plazo-moroso{% endif %}">
      
      <!-- ORDEN -->
      <td style="width:100px;">
        <form action="{{ url_for('rutas.actualizar_orden', cliente_id=c.id) }}" method="post" class="d-flex actualizar-orden-form">
          <input type="number" name="orden" value="{{ c.orden }}" class="form-control text-center" style="width:70px;" {% if c.cancelado %}disabled{% endif %}>
          <button type="submit" class="btn btn-outline-primary ms-1 btn-sm" {% if c.cancelado %}disabled{% endif %}>‚úî</button>
        </form>
      </td>

      <!-- DATOS PRINCIPALES -->
      <td>{{ c.codigo }}</td>
      <td>{{ c.fecha_creacion.strftime("%d/%m/%Y") }}</td>
      <td>{{ c.nombre }}</td>

      <!-- MONTO PRESTADO -->
      <td>{{ "%.2f"|format(c.capital_total_sin_interes()) }}</td>

      <!-- CUOTA -->
      <td>
        {{ "%.2f"|format(c.valor_cuota()) }}
        {% if c.prestamos %}
          {% set u = (c.prestamos|sort(attribute='fecha'))|last %}
          {% if u.frecuencia %}
            <small class="text-muted">({{ u.frecuencia }})</small>
          {% endif %}
        {% endif %}
      </td>

      <!-- CUOTAS ATRASADAS -->
      <td>{{ c.cuotas_atrasadas() }}</td>

      <!-- √öLTIMO ABONO -->
      <td>{{ "%.2f"|format(c.ultimo_abono_monto()) }}</td>

      <!-- ABONAR -->
      <td class="abono-td">
        {% if not c.cancelado %}
        <form action="{{ url_for('rutas.registrar_abono_por_codigo') }}" 
              method="post" 
              class="d-flex justify-content-center form-abono"
              data-orden="{{ c.orden }}">
          <input type="hidden" name="codigo" value="{{ c.codigo }}">
          <input type="number" step="0.01" min="0.01" name="monto" placeholder="0"
                 class="form-control text-end abono-input fw-bold {% if c.ultimo_abono_fecha == hoy %}bg-success text-white{% endif %}"
                 style="width:120px; height:50px; font-size:1.4rem;" 
                 required autocomplete="off">
          <button type="submit" class="btn btn-success ms-2" style="font-size:1.4rem; padding:0 15px;">üíµ</button>
        </form>
        {% else %}
          <span class="text-muted">Cancelado</span>
        {% endif %}
      </td>

      <!-- SALDO -->
      <td>
        {% if c.cancelado %}
          <span class="text-muted saldo-texto" data-cliente-id="{{ c.id }}">0.00</span>
        {% else %}
          <button class="btn btn-link p-0 saldo-clickable saldo-texto" data-cliente-id="{{ c.id }}">
            {{ "%.2f"|format(c.saldo_total()) }}
          </button>
        {% endif %}
      </td>

      <!-- EDITAR -->
      <td>
        <button class="btn btn-outline-primary btn-sm editar-btn" 
                data-id="{{ c.id }}" 
                data-nombre="{{ c.nombre }}">
          ‚úèÔ∏è
        </button>
      </td>

      <!-- ELIMINAR -->
      <td>
        <form action="{{ url_for('rutas.eliminar_cliente', cliente_id=c.id) }}" method="post"
              onsubmit="return confirm('¬øSeguro que deseas eliminar este cliente?');">
          <button type="submit" class="btn btn-danger btn-sm">‚ùå</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="alert alert-info text-center">No hay clientes registrados a√∫n.</div>
{% endif %}

<!-- =================== MODAL EDITAR PR√âSTAMO =================== -->
<div class="modal fade" id="modalEditarPrestamo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditarPrestamo" method="POST">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Editar Pr√©stamo de <span id="clienteNombre"></span></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Plazo (d√≠as)</label>
            <input type="number" name="plazo" id="editarPlazo" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Inter√©s (%)</label>
            <input type="number" step="0.01" name="interes" id="editarInteres" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Frecuencia</label>
            <select name="frecuencia" id="editarFrecuencia" class="form-select">
              <option value="diario">Diario</option>
              <option value="semanal">Semanal</option>
              <option value="quincenal">Quincenal</option>
              <option value="mensual">Mensual</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- =================== MODAL HISTORIAL DE ABONOS =================== -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalHistorialLabel">üìò Detalles del Cliente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

        <!-- üßæ DATOS DEL PR√âSTAMO -->
        <h6 class="fw-bold mb-3">Datos del Art√≠culo / Pr√©stamo</h6>
        <table class="table table-sm table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>Nombre</th><th>Fecha inicial</th><th>Monto</th><th>Total</th>
              <th>Cuota</th><th>Modo</th><th>Datos</th><th>Saldo</th>
            </tr>
          </thead>
          <tbody id="tablaDatosPrestamo">
            <tr><td colspan="8"><em>Cargando datos...</em></td></tr>
          </tbody>
        </table>

        <!-- üí∞ HISTORIAL DE ABONOS -->
        <h6 class="fw-bold mt-4 mb-3">Historial de Abonos</h6>
        <table class="table table-sm table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>C√≥digo</th><th>Fecha</th><th>Hora</th><th>Abono</th><th>Saldo</th><th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="tablaHistorialBody">
            <tr><td colspan="6"><em>Cargando...</em></td></tr>
          </tbody>
        </table>

      </div>
    </div>
  </div>
</div>

<!-- =================== JAVASCRIPT =================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===================== MODAL EDITAR PR√âSTAMO =====================
  const modalEditar = new bootstrap.Modal(document.getElementById("modalEditarPrestamo"));
  const formEditar = document.getElementById("formEditarPrestamo");

  document.querySelectorAll(".editar-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const nombre = btn.dataset.nombre;
      document.getElementById("clienteNombre").textContent = nombre;

      try {
        const res = await fetch(`/editar_prestamo/${id}`);
        const data = await res.json();
        if (!data.ok) {
          alert(data.error || "Error al cargar los datos del pr√©stamo.");
          return;
        }
        document.getElementById("editarPlazo").value = data.data.plazo || "";
        document.getElementById("editarInteres").value = data.data.interes || "";
        document.getElementById("editarFrecuencia").value = data.data.frecuencia || "diario";
        formEditar.dataset.id = id;
        modalEditar.show();
      } catch (err) {
        console.error(err);
        alert("Error al obtener los datos del pr√©stamo.");
      }
    });
  });

  formEditar.addEventListener("submit", async e => {
    e.preventDefault();
    const id = formEditar.dataset.id;
    const formData = new FormData(formEditar);
    try {
      const res = await fetch(`/editar_prestamo/${id}`, { method: "POST", body: formData });
      const data = await res.json();
      if (data.ok) {
        alert("‚úÖ " + data.msg);
        modalEditar.hide();
        location.reload();
      } else {
        alert("‚ùå " + (data.error || "Error al guardar los cambios."));
      }
    } catch (err) {
      console.error(err);
      alert("Error al enviar los datos del pr√©stamo.");
    }
  });

  // ===================== HISTORIAL DE ABONOS =====================
  document.querySelectorAll('.saldo-clickable').forEach(btn => {
    btn.addEventListener('click', async () => {
      const clienteId = btn.dataset.clienteId;
      const modal = new bootstrap.Modal(document.getElementById('modalHistorial'));
      const datosTbody = document.getElementById("tablaDatosPrestamo");
      const abonosTbody = document.getElementById("tablaHistorialBody");

      datosTbody.innerHTML = `<tr><td colspan="8"><em>Cargando...</em></td></tr>`;
      abonosTbody.innerHTML = `<tr><td colspan="6"><em>Cargando...</em></td></tr>`;

      try {
        const res = await fetch(`/historial_abonos/${clienteId}`);
        const data = await res.json();

        // üßæ DATOS DEL PR√âSTAMO
        const p = data.prestamo;
        datosTbody.innerHTML = `
          <tr>
            <td>${p.nombre}</td>
            <td>${p.fecha_inicial}</td>
            <td>$${p.monto.toFixed(2)}</td>
            <td>$${p.total.toFixed(2)}</td>
            <td>$${p.cuota.toFixed(2)}</td>
            <td>${p.modo}</td>
            <td>${p.datos}</td>
            <td>$${p.saldo.toFixed(2)}</td>
          </tr>
        `;

        // üí∞ HISTORIAL DE ABONOS
        abonosTbody.innerHTML = data.abonos.map(a => `
          <tr>
            <td>${a.codigo}</td>
            <td>${a.fecha}</td>
            <td>${a.hora}</td>
            <td>$${a.monto.toFixed(2)}</td>
            <td>$${a.saldo.toFixed(2)}</td>
            <td>
              ${a.id > 0
                ? `<button class="btn btn-danger btn-sm eliminar-abono" data-id="${a.id}" data-cliente="${clienteId}">üóëÔ∏è</button>`
                : `<span class="text-muted">‚Äî</span>`}
            </td>
          </tr>
        `).join("");

        // üîπ ELIMINAR ABONO SIN RECARGAR
        document.querySelectorAll(".eliminar-abono").forEach(boton => {
          boton.addEventListener("click", async () => {
            if (!confirm("¬øSeguro que deseas eliminar este abono?")) return;
            const id = boton.dataset.id;
            const cliente = boton.dataset.cliente;

            try {
              const r = await fetch(`/eliminar_abono/${id}`, {
                method: "POST",
                headers: { "X-Requested-With": "fetch" }
              });
              const resp = await r.json();

              if (resp.ok) {
                boton.closest("tr").remove();

                // üí≤ Actualizar saldo
                const saldoElem = document.querySelector(`.saldo-texto[data-cliente-id="${cliente}"]`);
                if (saldoElem) {
                  saldoElem.textContent = resp.saldo.toFixed(2);
                  saldoElem.style.transition = "background-color 0.6s";
                  saldoElem.style.backgroundColor = "rgba(255,0,0,0.2)";
                  setTimeout(() => saldoElem.style.backgroundColor = "", 800);
                }
              } else {
                alert(resp.error || "Error al eliminar el abono.");
              }
            } catch (err) {
              console.error(err);
              alert("Error al eliminar abono.");
            }
          });
        });

        modal.show();

      } catch (err) {
        console.error(err);
        alert("Error al cargar historial.");
      }
    });
  });
});
</script>

<!-- =================== ESTILOS =================== -->
<style>
.cancelado { background-color: #f8d7da; color: #721c24; }
.plazo-vencido { background-color: rgba(255,165,0,0.15)!important; }
.plazo-moroso { background-color: rgba(255,0,0,0.15)!important; }
.abono-td form { align-items:center; justify-content:center; gap:0.3em; }
.saldo-clickable { font-size:1em; font-weight:bold; color:#0d6efd; text-decoration:underline; cursor:pointer; }
.table-sm th, .table-sm td { vertical-align: middle; }
</style>
{% endblock %}
