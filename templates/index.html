{% extends "base.html" %}
{% block title %}Listado de Clientes{% endblock %}
{% block content %}
<h2>Listado de Clientes</h2>

<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>Código</th>
      <th>Orden</th>
      <th>Nombre</th>
      <th>Monto</th>
      <th>Interés</th>
      <th>Saldo</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for cliente in clientes %}
    <tr>
      <td>{{ cliente.codigo }}</td>

      <td style="width: 100px;">
        <form action="{{ url_for('actualizar_orden', cliente_id=cliente.id) }}" method="post" class="d-flex">
          <input type="number" name="nuevo_orden" class="form-control form-control-sm" value="{{ cliente.orden }}" min="1" required style="width:70px;">
          <button class="btn btn-sm btn-outline-primary ms-2" type="submit">Guardar</button>
        </form>
      </td>

      <td>{{ cliente.nombre }}</td>
      <td>{{ "%.2f"|format(cliente.monto) }}</td>
      <td>{{ "%.2f"|format(cliente.interes) }}%</td>
      <td>{{ "%.2f"|format(cliente.saldo) }}</td>

      <td>
        <div class="d-flex">
          <!-- Abonar -->
          <form action="{{ url_for('abonar', cliente_id=cliente.id) }}" method="post" class="d-flex me-2">
            <input type="number" name="monto_abono" class="form-control form-control-sm small-input" step="0.01" placeholder="Abono" required>
            <button class="btn btn-primary btn-sm" type="submit">Abonar</button>
          </form>

          <!-- Editar -->
          <a href="{{ url_for('editar_cliente', cliente_id=cliente.id) }}" class="btn btn-secondary btn-sm me-2">Editar</a>

          <!-- Eliminar cliente -->
          <form action="{{ url_for('eliminar_cliente', cliente_id=cliente.id) }}" method="post" onsubmit="return confirm('Eliminar cliente y sus abonos?');">
            <button class="btn btn-danger btn-sm" type="submit">Eliminar</button>
          </form>
        </div>

        <!-- Listado pequeño de abonos (últimos 3) y botón para ver todos -->
        <div class="mt-2">
          {% if cliente.abonos %}
            <small>Últimos abonos:</small>
            <ul class="list-unstyled mb-0">
              {% for a in cliente.abonos|slice(-3, 3) %}
                <li>
                  {{ a.fecha.strftime('%d/%m/%Y') }} - {{ "%.2f"|format(a.monto) }}
                  <form action="{{ url_for('eliminar_abono', abono_id=a.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Eliminar abono?');">
                    <button class="btn btn-link btn-sm text-danger p-0">[x]</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="mt-3">
  <a href="{{ url_for('nuevo_cliente') }}" class="btn btn-success">Nuevo Cliente</a>
  <a href="{{ url_for('liquidacion') }}" class="btn btn-secondary">Liquidación</a>
</div>
{% endblock %}
