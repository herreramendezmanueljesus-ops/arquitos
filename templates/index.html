{% extends "base.html" %}

{% block title %}Inicio{% endblock %}

{% block content %}
<h2 class="mb-4">Listado de Clientes</h2>

<!-- Botones principales -->
<div class="mb-3">
    <a class="btn btn-primary" href="{{ url_for('nuevo_cliente') }}">‚ûï Nuevo Cliente</a>
    <a class="btn btn-secondary" href="{{ url_for('liquidacion') }}">üìä Ver Liquidaci√≥n</a>
</div>

<!-- Totales de hoy -->
<p><strong>Hoy:</strong> {{ hoy.strftime("%d/%m/%Y") }}</p>
{% if liq_hoy %}
<div class="mb-3">
    <strong>Abonos hoy:</strong> {{ "%.2f"|format(liq_hoy.total_abonos) }} |
    <strong>Pr√©stamos hoy:</strong> {{ "%.2f"|format(liq_hoy.total_prestamos) }} |
    <strong>Caja:</strong> {{ "%.2f"|format(liq_hoy.caja) }} |
    <strong>Paquete:</strong> {{ "%.2f"|format(liq_hoy.paquete) }}
</div>
<canvas id="grafico-liquidacion" width="400" height="150"></canvas>
{% endif %}

{% if clientes %}
<table id="tabla-clientes" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>C√≥digo</th>
      <th>Fecha</th>
      <th>Nombre</th>
      <th>Monto</th>
      <th>Abono</th>
      <th>Saldo</th>
      <th>Eliminar</th>
    </tr>
  </thead>
  <tbody>
    {% for c in clientes %}
    <tr id="cliente-{{ c.id }}" {% if c.cancelado %}class="cancelado"{% endif %}>
      <!-- Orden -->
      <td style="width:100px;">
        <form action="{{ url_for('actualizar_orden', cliente_id=c.id) }}" method="post" class="d-flex actualizar-orden-form">
          <input type="number" name="orden" value="{{ c.orden }}"
                 class="form-control text-center"
                 style="width:70px;" {% if c.cancelado %}disabled{% endif %}/>
          <button type="submit" class="btn btn-outline-primary ms-1 btn-sm" {% if c.cancelado %}disabled{% endif %}>‚úî</button>
        </form>
      </td>

      <!-- C√≥digo -->
      <td>{{ c.codigo }}</td>

      <!-- Fecha -->
      <td>{{ c.fecha_creacion.strftime("%d/%m/%Y") }}</td>

      <!-- Nombre -->
      <td>{{ c.nombre }}</td>

      <!-- Monto -->
      <td>{{ "%.2f"|format(c.monto) }}</td>

      <!-- Abono -->
      <td class="abono-td">
        {% if not c.cancelado %}
        <form action="{{ url_for('abonar', cliente_id=c.id) }}" method="post" class="d-flex">
          <input type="number" step="0.01" min="0.01" name="monto_abono" placeholder="0"
                 class="form-control abono-input text-end" 
                 data-cliente-id="{{ c.id }}" style="font-size: 1.5em; padding: 0.4em;"/>
          <button type="submit" class="btn btn-success ms-1 btn-sm">üíµ</button>
        </form>
        <!-- Historial oculto (ya no se usar√° en tabla, pero lo dejamos por compatibilidad) -->
        <div class="historial-abonos mt-1" id="historial-{{ c.id }}" style="display:none;"></div>
        {% else %}
        0.00
        {% endif %}
      </td>

      <!-- Saldo -->
      <td>
        {% if c.cancelado %}
          0.00
        {% else %}
          {{ "%.2f"|format(c.saldo) }}
        {% endif %}
      </td>

      <!-- Eliminar cliente -->
      <td>
        <form action="{{ url_for('eliminar_cliente', cliente_id=c.id) }}" method="post"
              onsubmit="return confirm('¬øSeguro que deseas eliminar este cliente?');">
          <button type="submit" class="btn btn-danger btn-sm">‚ùå</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="alert alert-info">No hay clientes registrados todav√≠a.</div>
{% endif %}

<!-- ================== MODAL HISTORIAL ================== -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalHistorialLabel">Historial de Abonos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Nombre</th>
              <th>Monto</th>
              <th>Eliminar</th>
            </tr>
          </thead>
          <tbody id="tablaHistorialBody">
            <tr><td colspan="5"><em>Cargando...</em></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Script para abonos, scroll y historial -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const abonoForms = document.querySelectorAll('.abono-td form');
    abonoForms.forEach((form, idx, forms) => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = form.querySelector('.abono-input');
            const td = form.closest('.abono-td');
            const clienteId = form.action.split('/').pop();
            const monto = parseFloat(input.value);

            if (isNaN(monto) || monto <= 0) {
                alert("Monto inv√°lido");
                return;
            }

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `monto_abono=${monto}`
                });

                const data = await response.json();

                if (data.success) {
                    td.classList.add("abono-realizado");
                    input.classList.add("abono-realizado");

                    const saldoTd = td.nextElementSibling;
                    if (saldoTd) saldoTd.textContent = data.nuevo_saldo;

                    input.value = '';

                    const hoy = "{{ hoy.strftime('%Y-%m-%d') }}";
                    let abonados = JSON.parse(localStorage.getItem("abonados_" + hoy) || "[]");
                    if (!abonados.includes(clienteId)) {
                        abonados.push(clienteId);
                        localStorage.setItem("abonados_" + hoy, JSON.stringify(abonados));
                    }

                    const nextForm = forms[idx + 1];
                    if (nextForm) {
                        const nextInput = nextForm.querySelector('.abono-input');
                        if (nextInput) nextInput.focus();
                    }
                } else {
                    alert(data.mensaje);
                }
            } catch (err) {
                console.error(err);
                alert("Error al registrar abono.");
            }
        });
    });

    // NUEVO: Long press + doble clic para abrir historial en modal
    document.querySelectorAll('.abono-input').forEach(input => {
        let pressTimer;
        const clienteId = input.dataset.clienteId;

        // Long press
        input.addEventListener('mousedown', () => {
            pressTimer = setTimeout(() => {
                cargarHistorial(clienteId);
            }, 600);
        });
        input.addEventListener('mouseup', () => clearTimeout(pressTimer));
        input.addEventListener('mouseleave', () => clearTimeout(pressTimer));

        // Doble clic
        input.addEventListener('dblclick', () => {
            cargarHistorial(clienteId);
        });
    });

    async function cargarHistorial(clienteId) {
        try {
            const response = await fetch(`/historial_abonos/${clienteId}`);
            const data = await response.json();
            const tbody = document.getElementById("tablaHistorialBody");

            if (data.abonos.length > 0) {
                tbody.innerHTML = data.abonos.map(a => `
                    <tr>
                      <td>${a.fecha}</td>
                      <td>${a.hora || ""}</td>
                      <td>${a.nombre || ""}</td>
                      <td>${a.monto.toFixed(2)}</td>
                      <td>
                        <form method="post" action="/eliminar_abono/${a.id}" 
                              onsubmit="return confirm('¬øEliminar este abono?');">
                          <button type="submit" class="btn btn-danger btn-sm">‚ùå</button>
                        </form>
                      </td>
                    </tr>
                `).join("");
            } else {
                tbody.innerHTML = `<tr><td colspan="5"><em>No hay abonos registrados</em></td></tr>`;
            }

            const modal = new bootstrap.Modal(document.getElementById('modalHistorial'));
            modal.show();
        } catch (err) {
            console.error(err);
            alert("Error cargando historial.");
        }
    }

    // Limpiar localStorage antiguo
    const hoy = "{{ hoy.strftime('%Y-%m-%d') }}";
    Object.keys(localStorage).forEach(k => {
        if (k.startsWith("abonados_") && k !== "abonados_" + hoy) {
            localStorage.removeItem(k);
        }
    });

    const abonados = JSON.parse(localStorage.getItem("abonados_" + hoy) || "[]");
    abonados.forEach(id => {
        const td = document.querySelector(`#cliente-${id} .abono-td`);
        if (td) {
            td.classList.add("abono-realizado");
            const input = td.querySelector('.abono-input');
            if (input) input.classList.add("abono-realizado");
        }
    });

    // Scroll al nuevo cliente
    const params = new URLSearchParams(window.location.search);
    const nuevoId = params.get("nuevo_id");
    if (nuevoId) {
        const fila = document.getElementById("cliente-" + nuevoId);
        if (fila) {
            fila.scrollIntoView({ behavior: "smooth", block: "center" });
            fila.style.transition = "background-color 1s ease";
            fila.style.backgroundColor = "#fff3cd";
            setTimeout(() => fila.style.backgroundColor = "", 3000);
        }
    }
});
</script>

<style>
/* Clientes cancelados con fondo rojo suave */
.cancelado {
    background-color: #f8d7da;
    color: #721c24;
}

/* Input de abonos m√°s grande */
.abono-input {
    font-size: 1.5em;
    padding: 0.4em;
}
</style>

{% endblock %}



