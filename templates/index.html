{% extends "base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<h2 class="mb-4">üìã Listado de Clientes</h2>

<!-- Botones principales -->
<div class="mb-3 d-flex flex-wrap gap-2">
  <a class="btn btn-primary" href="{{ url_for('nuevo_cliente') }}">‚ûï Nuevo Cliente</a>
  <a class="btn btn-secondary" href="{{ url_for('liquidacion') }}">üìä Ver Liquidaci√≥n</a>
  <a class="btn btn-outline-dark" href="{{ url_for('clientes_cancelados_view') }}">üö´ Cancelados</a>
</div>

<!-- Fecha y totales -->
<p><strong>Fecha:</strong> {{ hoy.strftime("%d/%m/%Y") }}</p>
<div class="mb-3">
  <strong>Caja total:</strong> ${{ "%.2f"|format(resumen.caja_total) }} |
  <strong>Cartera total:</strong> ${{ "%.2f"|format(resumen.cartera_total) }}
</div>

{% if clientes %}
<table id="tabla-clientes" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>C√≥digo</th>
      <th>Fecha</th>
      <th>Nombre</th>
      <th>Monto Prestado</th>
      <th>Abonar</th>
      <th>Saldo</th>
      <th>Eliminar</th>
    </tr>
  </thead>
  <tbody>
    {% for c in clientes %}
    <tr id="cliente-{{ c.id }}"
        class="{% if c.cancelado %}cancelado{% elif c.estado_plazo == 'vencido' %}plazo-vencido{% elif c.estado_plazo == 'moroso' %}plazo-moroso{% endif %}">
      
      <!-- Orden -->
      <td style="width:100px;">
        <form action="{{ url_for('actualizar_orden', cliente_id=c.id) }}" method="post" class="d-flex actualizar-orden-form">
          <input type="number" name="orden" value="{{ c.orden }}" class="form-control text-center" style="width:70px;"
                 {% if c.cancelado %}disabled{% endif %}>
          <button type="submit" class="btn btn-outline-primary ms-1 btn-sm" {% if c.cancelado %}disabled{% endif %}>‚úî</button>
        </form>
      </td>

      <td>{{ c.codigo }}</td>
      <td>{{ c.fecha_creacion.strftime("%d/%m/%Y") }}</td>
      <td>{{ c.nombre }}</td>
      <td>{{ "%.2f"|format(c.capital_total()) }}</td>

      <!-- Abono -->
      <td class="abono-td">
        {% if not c.cancelado %}
        <form action="{{ url_for('registrar_abono_por_codigo') }}" 
              method="post" 
              class="d-flex justify-content-center form-abono"
              data-orden="{{ c.orden }}">
          <input type="hidden" name="codigo" value="{{ c.codigo }}">
          <input type="number" step="0.01" min="0.01" name="monto" placeholder="0"
                 class="form-control text-end abono-input fw-bold {% if c.ultimo_abono_fecha == hoy %}bg-success text-white{% endif %}"
                 style="width:120px; height:50px; font-size:1.4rem;" 
                 required autocomplete="off">
          <button type="submit" class="btn btn-success ms-2" style="font-size:1.4rem; padding:0 15px;">üíµ</button>
        </form>
        {% else %}
          <span class="text-muted">Cancelado</span>
        {% endif %}
      </td>

      <!-- Saldo -->
      <td>
        {% if c.cancelado %}
          <span class="text-muted saldo-texto" data-cliente-id="{{ c.id }}">0.00</span>
        {% else %}
          <button class="btn btn-link p-0 saldo-clickable saldo-texto" data-cliente-id="{{ c.id }}">
            {{ "%.2f"|format(c.saldo_total()) }}
          </button>
        {% endif %}
      </td>

      <!-- Eliminar cliente -->
      <td>
        <form action="{{ url_for('eliminar_cliente', cliente_id=c.id) }}" method="post"
              onsubmit="return confirm('¬øSeguro que deseas eliminar este cliente?');">
          <button type="submit" class="btn btn-danger btn-sm">‚ùå</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="alert alert-info">No hay clientes registrados a√∫n.</div>
{% endif %}

<!-- ================== MODAL HISTORIAL ================== -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalHistorialLabel">Historial de Abonos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Nombre</th>
              <th>Monto</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="tablaHistorialBody">
            <tr><td colspan="5"><em>Cargando...</em></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ================== SCRIPTS ================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  // --- Historial de abonos ---
  document.querySelectorAll('.saldo-clickable').forEach(btn => {
    btn.addEventListener('click', async () => {
      const clienteId = btn.dataset.clienteId;
      try {
        const response = await fetch(`/historial_abonos/${clienteId}`);
        const data = await response.json();
        const tbody = document.getElementById("tablaHistorialBody");

        if (data.abonos.length > 0) {
          tbody.innerHTML = data.abonos.map(a => `
            <tr>
              <td>${a.fecha}</td>
              <td>${a.hora || ""}</td>
              <td>${a.nombre || ""}</td>
              <td>$${a.monto.toFixed(2)}</td>
              <td>
                <button class="btn btn-danger btn-sm eliminar-abono" data-id="${a.id}">üóëÔ∏è</button>
              </td>
            </tr>
          `).join("");
        } else {
          tbody.innerHTML = `<tr><td colspan="5"><em>No hay abonos registrados</em></td></tr>`;
        }

        // ‚úÖ Eliminaci√≥n de abonos con actualizaci√≥n en vivo
        document.querySelectorAll('.eliminar-abono').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('¬øSeguro que deseas eliminar este abono?')) return;
            const id = btn.dataset.id;
            try {
              const res = await fetch(`/eliminar_abono/${id}`, { 
                method: 'POST', 
                headers: { 'X-Requested-With': 'fetch' } 
              });
              if (!res.ok) return alert('Error al eliminar el abono.');

              const data = await res.json();
              btn.closest('tr').remove();

              // üí≤ Actualizar saldo en tiempo real
              const saldoElem = document.querySelector(`.saldo-texto[data-cliente-id="${data.cliente_id}"]`);
              if (saldoElem) {
                saldoElem.textContent = data.saldo.toFixed(2);
                saldoElem.style.transition = "background-color 0.6s";
                saldoElem.style.backgroundColor = data.saldo > 0 ? "rgba(0,255,0,0.2)" : "rgba(255,0,0,0.2)";
                setTimeout(() => saldoElem.style.backgroundColor = "", 800);
              }

              // üîÅ Si vuelve a estar activo, quitar opacidad
              const fila = saldoElem ? saldoElem.closest("tr") : null;
              if (fila && data.saldo > 0) fila.style.opacity = "1";

            } catch (err) {
              console.error(err);
              alert("Error de conexi√≥n al eliminar abono.");
            }
          });
        });

        new bootstrap.Modal(document.getElementById('modalHistorial')).show();
      } catch (err) {
        console.error(err);
        alert("Error al cargar historial.");
      }
    });
  });

  // --- ‚úÖ Registro de abonos r√°pido, actualiza saldo autom√°ticamente ---
  const forms = document.querySelectorAll('.form-abono');

  function playSound(success = true) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = success ? 'triangle' : 'sawtooth';
      osc.frequency.setValueAtTime(success ? 880 : 220, ctx.currentTime);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.15);
    } catch {}
  }

  const hoy = new Date().toISOString().slice(0, 10);
  forms.forEach(form => {
    const codigoCliente = form.querySelector('input[name="codigo"]').value;
    const fechaGuardada = localStorage.getItem(`abonado_${codigoCliente}`);
    const input = form.querySelector('input[name="monto"]');
    if (fechaGuardada === hoy) input.classList.add('bg-success', 'text-white');
  });

  forms.forEach((form) => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = form.querySelector('input[name="monto"]');
      const formData = new FormData(form);
      try {
        const res = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'fetch' }
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          playSound(false);
          alert(data.error || "‚ùå Error al registrar el abono.");
          return;
        }

        const saldoElem = document.querySelector(`.saldo-texto[data-cliente-id="${data.cliente_id}"]`);
        if (saldoElem) {
          saldoElem.textContent = data.saldo.toFixed(2);
          saldoElem.style.transition = "background-color 0.6s";
          saldoElem.style.backgroundColor = data.cancelado ? "rgba(255,0,0,0.2)" : "rgba(0,255,0,0.2)";
          setTimeout(() => saldoElem.style.backgroundColor = "", 800);
        }

        playSound(true);
        input.classList.add('bg-success', 'text-white');
        input.value = '';
        const codigoCliente = form.querySelector('input[name="codigo"]').value;
        localStorage.setItem(`abonado_${codigoCliente}`, hoy);

        const fila = form.closest('tr');
        if (fila) {
          fila.classList.add('fila-parpadea');
          setTimeout(() => fila.classList.remove('fila-parpadea'), 1200);
        }

        const ordenActual = parseInt(form.dataset.orden);
        const siguiente = document.querySelector(`.form-abono[data-orden="${ordenActual + 1}"]`);
        if (siguiente) siguiente.querySelector('input[name="monto"]').focus();
        else forms[0].querySelector('input[name="monto"]').focus();
      } catch (error) {
        playSound(false);
        console.error(error);
        alert("Error de conexi√≥n al registrar abono.");
      }
    });
  });
});

// üïõ Limpieza autom√°tica localStorage
(function limpiarAbonosViejos() {
  const hoy = new Date().toISOString().slice(0, 10);
  Object.keys(localStorage).forEach(k => {
    if (k.startsWith("abonado_") && localStorage.getItem(k) !== hoy) localStorage.removeItem(k);
  });
})();
</script>

<style>
.cancelado { background-color: #f8d7da; color: #721c24; }
.plazo-vencido { background-color: rgba(255,165,0,0.15)!important; }
.plazo-moroso { background-color: rgba(255,0,0,0.15)!important; }
@keyframes parpadeoVerde {
  0% { background-color: #d4edda; }
  50% { background-color: #b6e0c3; }
  100% { background-color: transparent; }
}
.fila-parpadea { animation: parpadeoVerde 1s ease-out; }
.abono-td form{align-items:center;justify-content:center;gap:0.3em;}
.saldo-clickable{font-size:1em;font-weight:bold;color:#0d6efd;text-decoration:underline;}
</style>
{% endblock %}
