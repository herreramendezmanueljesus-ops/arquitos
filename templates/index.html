{% extends "base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<h2 class="mb-4">üìã Listado de Clientes</h2>

<!-- Botones principales -->
<div class="mb-3 d-flex flex-wrap gap-2">
  <a class="btn btn-primary" href="{{ url_for('nuevo_cliente') }}">‚ûï Nuevo Cliente</a>
  <a class="btn btn-secondary" href="{{ url_for('liquidacion') }}">üìä Ver Liquidaci√≥n</a>
  <a class="btn btn-outline-dark" href="{{ url_for('clientes_cancelados_view') }}">üö´ Cancelados</a>
</div>

<!-- Fecha y totales -->
<p><strong>Fecha:</strong> {{ hoy.strftime("%d/%m/%Y") }}</p>
<div class="mb-3">
  <strong>Caja total:</strong> ${{ "%.2f"|format(resumen.caja_total) }} |
  <strong>Cartera total:</strong> ${{ "%.2f"|format(resumen.cartera_total) }}
</div>

{% if clientes %}
<table id="tabla-clientes" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>C√≥digo</th>
      <th>Fecha</th>
      <th>Nombre</th>
      <th>Monto Prestado</th>
      <th>Abonar</th>
      <th>Saldo</th>
      <th>Eliminar</th>
    </tr>
  </thead>
  <tbody>
    {% for c in clientes %}
    <tr id="cliente-{{ c.id }}" {% if c.cancelado %}class="cancelado"{% endif %}>
      <!-- Orden -->
      <td style="width:100px;">
        <form action="{{ url_for('actualizar_orden', cliente_id=c.id) }}" method="post" class="d-flex actualizar-orden-form">
          <input type="number" name="orden" value="{{ c.orden }}" class="form-control text-center" style="width:70px;"
                 {% if c.cancelado %}disabled{% endif %}>
          <button type="submit" class="btn btn-outline-primary ms-1 btn-sm" {% if c.cancelado %}disabled{% endif %}>‚úî</button>
        </form>
      </td>

      <td>{{ c.codigo }}</td>
      <td>{{ c.fecha_creacion.strftime("%d/%m/%Y") }}</td>
      <td>{{ c.nombre }}</td>
      <td>{{ "%.2f"|format(c.capital_total()) }}</td>

      <!-- Abono -->
      <td class="abono-td">
        {% if not c.cancelado %}
        <form action="{{ url_for('registrar_abono_por_codigo') }}" method="post" class="d-flex justify-content-center">
          <input type="hidden" name="codigo" value="{{ c.codigo }}">
          <input type="number" step="0.01" min="0.01" name="monto" placeholder="0"
                 class="form-control text-end abono-input fw-bold"
                 style="width:120px; height:50px; font-size:1.4rem;" required>
          <button type="submit" class="btn btn-success ms-2" style="font-size:1.4rem; padding:0 15px;">üíµ</button>
        </form>
        {% else %}
          <span class="text-muted">Cancelado</span>
        {% endif %}
      </td>

      <!-- Saldo (clickable para historial) -->
      <td>
        {% if c.cancelado %}
          <span class="text-muted">0.00</span>
        {% else %}
          <button class="btn btn-link p-0 saldo-clickable" data-cliente-id="{{ c.id }}">
            {{ "%.2f"|format(c.saldo_total()) }}
          </button>
        {% endif %}
      </td>

      <!-- Eliminar cliente -->
      <td>
        <form action="{{ url_for('eliminar_cliente', cliente_id=c.id) }}" method="post"
              onsubmit="return confirm('¬øSeguro que deseas eliminar este cliente?');">
          <button type="submit" class="btn btn-danger btn-sm">‚ùå</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="alert alert-info">No hay clientes registrados a√∫n.</div>
{% endif %}

<!-- ================== MODAL HISTORIAL ================== -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalHistorialLabel">Historial de Abonos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Nombre</th>
              <th>Monto</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="tablaHistorialBody">
            <tr><td colspan="5"><em>Cargando...</em></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ================== SCRIPTS ================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll('.saldo-clickable').forEach(btn => {
    btn.addEventListener('click', async () => {
      const clienteId = btn.dataset.clienteId;
      try {
        const response = await fetch(`/historial_abonos/${clienteId}`);
        const data = await response.json();
        const tbody = document.getElementById("tablaHistorialBody");

        if (data.abonos.length > 0) {
          tbody.innerHTML = data.abonos.map(a => `
            <tr>
              <td>${a.fecha}</td>
              <td>${a.hora || ""}</td>
              <td>${a.nombre || ""}</td>
              <td>$${a.monto.toFixed(2)}</td>
              <td>
                <button class="btn btn-danger btn-sm eliminar-abono" data-id="${a.id}">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          `).join("");
        } else {
          tbody.innerHTML = `<tr><td colspan="5"><em>No hay abonos registrados</em></td></tr>`;
        }

        // Activar eliminaci√≥n
        document.querySelectorAll('.eliminar-abono').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('¬øSeguro que deseas eliminar este abono?')) return;
            const id = btn.dataset.id;
            const res = await fetch(`/eliminar_abono/${id}`, { method: 'POST' });
            if (res.ok) {
              btn.closest('tr').remove();
            } else {
              alert('Error al eliminar el abono.');
            }
          });
        });

        new bootstrap.Modal(document.getElementById('modalHistorial')).show();
      } catch (err) {
        console.error(err);
        alert("Error al cargar historial.");
      }
    });
  });
});
</script>

<style>
.cancelado {
  background-color: #f8d7da;
  color: #721c24;
}

/* üì± Ajustes responsivos: igual que el input de productos */
@media (max-width: 768px) {
  .abono-input {
    width: 160px !important;
    height: 60px !important;
    font-size: 1.8rem !important;
  }
  .btn-success {
    font-size: 1.8rem !important;
    padding: 5px 20px !important;
  }
}

/* üíª En pantallas grandes */
@media (min-width: 769px) {
  .abono-input {
    width: 120px;
    height: 50px;
    font-size: 1.4rem;
  }
  .btn-success {
    font-size: 1.4rem;
    padding: 0 15px;
  }
}

/* üîπ Alineaci√≥n del formulario */
.abono-td form {
  align-items: center;
  justify-content: center;
  gap: 0.3em;
}

/* üîπ Bot√≥n de saldo */
.saldo-clickable {
  font-size: 1em;
  font-weight: bold;
  color: #0d6efd;
  text-decoration: underline;
}
</style>

{% endblock %}
